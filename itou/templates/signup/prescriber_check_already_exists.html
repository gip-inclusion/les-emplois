{% extends "layout/content_small.html" %}
{% load bootstrap4 %}
{% load static %}
{% load format_filters %}

{% block title %}Prescripteur/Orienteur - Inscription{{ block.super }}{% endblock %}

{% block content %}

    <h1>
        Inscription
        <small class="text-muted">Prescripteur/Orienteur</small>
    </h1>

    <h2>
        Votre organisation est-elle déjà inscrite ?
    </h2>

    <p class="mb-6">
        <a href="{% url 'signup:prescriber_pole_emploi_safir_code' %}">Je travaille pour Pôle emploi</a>
    </p>
    <form method="post" action="" class="js-prevent-multiple-submit">

        {% csrf_token %}

        {% bootstrap_form form alert_error_type="all" %}

        {% buttons %}
            <button type="submit" class="btn btn-primary">Rechercher</button>
        {% endbuttons %}

    </form>

    {# Display link only before the search otherwise an organization is put in session and no longer allows creation without an organization  #}
    {% if not prescriber_orgs_with_members_same_siret and not prescriber_orgs_with_members_same_siren %}
    <p class="mt-3">
        <a href="{% url 'signup:prescriber_user' %}">Je ne fais partie d'aucune organisation</a>
    </p>
    {% endif %}

    {% if prescriber_orgs_with_members_same_siret %}
        <div class="mt-5">
            <h3>Organisation(s) déjà inscrite(s) avec ce SIRET</h3>
            <p>Par mesure sécurité, vous devez obtenir une invitation pour rejoindre une organisation déjà inscrite.</p>
            {% for prescriber_org in prescriber_orgs_with_members_same_siret %}
                <div class="card my-4">
                    <div class="card-body">
                        <h3 class="card-title">
                            <b>{{ prescriber_org.siret|format_siret }}</b> - {{ prescriber_org.kind }}
                        </h3>
                        {{ prescriber_org.display_name }}
                        <br>
                        {{ prescriber_org.address_line_1 }},
                        {% if prescriber_org.address_line_2 %}
                            <br>
                            {{ prescriber_org.address_line_2 }},
                        {% endif %}
                        <br>
                        {{ prescriber_org.post_code }} {{ prescriber_org.city }}
                    </div>
                    <div class="card-footer">
                        {# Organizations can exist without a member  #}
                        {% if prescriber_org.prescribermembership_set.first %}
                            {% with prescriber_org.prescribermembership_set.first as membership %}
                                {# Ordered by -is_admin and date_joined via prefetch_active_memberships #}
                                {# For security, display only the first char of the last name. #}
                                <i>
                                    Demandez une invitation à
                                    {{ membership.user.first_name|title }} {{ membership.user.last_name|slice:1 }}.
                                    pour rejoindre cette organisation.
                                </i>
                                <br>
                                <a href="{% url 'signup:prescriber_request_invitation' membership.id %}" class="btn btn-secondary mt-2">
                                    Demander une invitation
                                </a>
                            {% endwith %}
                        {% else %}
                            <i>Cette organisation n'a pas de membre.</i>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if prescriber_orgs_with_members_same_siren %}
        <div class="mt-5">
            {% if not prescriber_orgs_with_members_same_siret %}
            <h3>Organisation(s) inscrite(s) avec ce SIREN sur le département</h3>
            <p>Par mesure sécurité, vous devez obtenir une invitation pour rejoindre une organisation déjà inscrite.</p>
            {% else %}
            <h3>Autre(s) organisation(s) inscrite(s) avec ce SIREN sur le département</h3>
            {% endif %}
            
            {% for prescriber_org in prescriber_orgs_with_members_same_siren %}
            <div class="card my-4">
                <div class="card-body">
                    <h3 class="card-title">
                        <b>{{ prescriber_org.siret|format_siret }}</b> - {{ prescriber_org.kind }}
                    </h3>
                    <br>
                    {{ prescriber_org.display_name }}
                    <br>
                    {{ prescriber_org.address_line_1 }},
                    {% if prescriber_org.address_line_2 %}
                        <br>
                        {{ prescriber_org.address_line_2 }},
                    {% endif %}
                    <br>
                    {{ prescriber_org.post_code }} {{ prescriber_org.city }}
                </div>
                {% with prescriber_org.prescribermembership_set.first as membership %}
                <div class="card-footer">
                    {# Ordered by -is_admin and date_joined via prefetch_active_memberships #}
                    {# For security, display only the first char of the last name. #}
                    <i>
                        Demandez une invitation à
                        {{ membership.user.first_name|title }} {{ membership.user.last_name|slice:1 }}.
                        pour rejoindre cette organisation.
                    </i>
                    <br>
                    <a href="{% url 'signup:prescriber_request_invitation' membership.id %}" class="btn btn-secondary mt-2">
                        Demander une invitation
                    </a>
                </div>
                {% endwith %}
            </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if prescriber_orgs_with_members_same_siret or prescriber_orgs_with_members_same_siren %}
    <div class="mt-5">
        <h3>Ajouter mon organisation</h3>

        {% if prescriber_orgs_with_members_same_siret %}
        <div class="alert alert-warning pb-0" role="alert">
            <p>
                <small>
                    Attention une ou plusieurs organisations existent déjà avec ce SIRET.<br>
                    Si vous ne trouvez pas votre organisation dans la liste ci-dessus ou si
                    vous souhaitez créer un compte avec ce SIRET pour un autre type
                    d'organisation, vous avez la possibilité de l'inscrire.
                </small>
            </p>
        </div>
        {% else %}
        <p>
            <small>
                Si vous ne trouvez pas votre organisation dans la liste ci-dessus, vous avez la possibilité de l'inscrire.
            </small>
        </p>
        {% endif %}
        <a class="btn btn btn-outline-secondary mt-3" href="{{ prev_url }}">Retour</a>
        <a href="{% url 'signup:prescriber_choose_org' %}" class="btn btn-primary mt-3">Inscrire mon organisation</a>
    </div>
    {% endif %}
{% endblock %}
