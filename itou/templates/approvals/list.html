{% extends "layout/base.html" %}
{% load components %}
{% load django_bootstrap5 %}
{% load matomo %}
{% load static %}
{% load str_filters %}

{% block title %}Salariés et PASS IAE {{ block.super }}{% endblock %}

{% block title_content %}
    {% component_title c_title__main=c_title__main %}
        {% fragment as c_title__main %}
            <h1>Salariés</h1>
        {% endfragment %}
    {% endcomponent_title %}
{% endblock %}

{% block title_extra %}
    {% if request.current_organization.can_use_employee_record %}
        <ul class="s-tabs-01__nav nav nav-tabs mb-0" data-it-sliding-tabs="true">
            <li class="nav-item active">
                <a class="nav-link active" href="{% url 'approvals:list' %}" {% matomo_event "employeurs" "clic" "onglet-salaries-pass-iae" %}>
                    Salariés et PASS IAE
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'employee_record_views:list' %}" {% matomo_event "employeurs" "clic" "onglet-fiches-salaries" %}>
                    <span>Fiches salarié ASP</span>
                    {% if num_rejected_employee_records %}
                        <span class="badge badge-sm rounded-pill bg-warning text-white ms-2">{{ num_rejected_employee_records }}</span>
                    {% endif %}
                </a>
            </li>
        </ul>
    {% endif %}
{% endblock %}

{% block content %}
    <section class="s-section">
        <div class="s-section__container container">
            <div class="s-section__row row">
                <div class="col-12">
                    <div class="tab-content">
                        <h2 class="mb-3 mb-md-4">Salariés et PASS IAE</h2>
                        {% include "includes/mon_recap_banner.html" with request=request mon_recap_banner_departments=mon_recap_banner_departments only %}
                        <form hx-get="{% url 'approvals:list' %}"
                              hx-trigger="change delay:.5s, change from:#id_job_seeker"
                              hx-indicator="#approvals-list"
                              hx-target="#approvals-list"
                              hx-swap="outerHTML"
                              hx-push-url="true"
                              hx-include="#id_job_seeker">
                            <input id="display-kind" type="hidden" name="display" value="{{ display_kind }}">
                            <div class="btn-dropdown-filter-group mb-3 mb-md-4">
                                {% include "approvals/includes/approvals_filters/status.html" %}
                                {% include "includes/btn_dropdown_filter/radio.html" with field=filters_form.expiry only %}
                                {% include "approvals/includes/contract_status_filter.html" with filters_form=filters_form ITOU_HELP_CENTER_URL=ITOU_HELP_CENTER_URL only %}
                                {% include "approvals/includes/list_reset_filters.html" %}
                            </div>
                        </form>

                        <div class="d-flex flex-column flex-md-row align-items-md-center mb-3 mb-md-4">
                            <div class="flex-md-grow-1">{% include "approvals/includes/list_counter.html" %}</div>
                            <div class="flex-column flex-md-row mt-3 mt-md-0">
                                {% bootstrap_field filters_form.job_seeker wrapper_class="w-lg-400px" show_label=False %}
                            </div>
                            <div class="d-flex gap-2 mt-3 mt-md-0 ms-0 ms-md-2" role="group" aria-label="Changement du mode d'affichage des salariés et PASS IAE">
                                {% include "common/list_view_switcher.html" with display_kind=display_kind request=request only %}
                            </div>
                        </div>
                        {% include "approvals/includes/list_results.html" %}
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block script %}
    {{ block.super }}
    <script src='{% static "js/sliding_tabs.js" %}'></script>
    <script src='{% static "js/htmx_compat.js" %}'></script>
    <script src='{% static "js/htmx_dropdown_filter.js" %}'></script>
    <!-- Needed to use the Select2MultipleWidget JS widget. -->
    {{ filters_form.media.js }}
    {# djlint:off #}
    <script nonce="{{ CSP_NONCE }}">
        window.addEventListener("load", () => {
            const breakpointMD = getComputedStyle(document.documentElement).getPropertyValue('--bs-breakpoint-md');
            const filterDropdown = document.getElementById('intro-js-contract-status-filter');

            if (filterDropdown && window.matchMedia('(min-width: ' + breakpointMD + ')').matches) {
                setTimeout(function() {
                    introJs.tour().setOptions({
                            disableInteraction: true,
                            dontShowAgain: true,
                            dontShowAgainCookie: "introjsContractStatusFilterDontShowAgain",
                            dontShowAgainCookieDays: 90,
                            dontShowAgainLabel: "Ne plus afficher",
                            showProgress: false,
                            showBullets: false,
                            skipLabel: '',
                            nextLabel: 'Suivant',
                            prevLabel: 'Précédent',
                            doneLabel: 'Fin',
                            steps: [{
                                element: document.querySelector('#intro-js-contract-status-filter'),
                                title: 'Découvrez le filtre par statut du contrat',
                                intro: 'Vous pouvez maintenant filtrer les PASS IAE par contrats en cours ou terminés depuis moins de 3 mois.'
                            }]
                        })
                        .start();
                }, 300)
            }
        });
</script>
    {# djlint:on #}
{% endblock %}
