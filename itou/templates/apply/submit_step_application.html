{% extends "apply/submit_base.html" %}
{% load bootstrap4 %}
{% load i18n %}
{% load static %}

{% block extra_head %}
    <!-- Dropzone -->
    <link rel="stylesheet" type="text/css" href='{% static "vendor/dropzone/dropzone.min.css" %}'>
{% endblock extra_head %}

{% block content %}

    {{ block.super }}

    <form method="post" action="" class="js-prevent-multiple-submit">

        {% csrf_token %}

        {% if siae.jobs.exists %}
            {% bootstrap_field form.selected_jobs %}
        {% endif %}

        {% bootstrap_field form.message %}
        {% bootstrap_field form.resume_link %}

        {{ form.resume_link.as_hidden }}
        <div id="resume_form" class="dropzone"></div>

        {% buttons %}
            <button type="submit" class="btn btn-primary">
                {% if request.user.is_siae_staff %}
                    Enregistrer la candidature
                {% else %}
                    Envoyer la candidature
                {% endif %}
            </button>
        {% endbuttons %}

    </form>

<!--     <form method="post" action="{{ s3_form_endpoint }}" enctype="multipart/form-data" class="dropzone" id="resume_form">
        <input type="hidden" name="policy" value="{{ s3_form_policy }}">
        <input type="hidden" name="x-amz-algorithm" value="AWS4-HMAC-SHA256">
        <input type="hidden" name="x-amz-credential" value="{{ s3_form_credential }}">
        <input type="hidden" name="x-amz-date" value="{{ s3_form_date }}">
        <input type="hidden" name="x-amz-signature" value="{{ s3_form_signature }}">

        <!-- Don't move me: I must be the last form item! -->
        <!-- <input type="hidden" name="key" value="" id="file_key"> -->
    <!-- </form> -->

{% endblock %}

{% block script %}
    {{ block.super }}
    <!-- Needed to use the Datepicker JS widget. -->
    {{ form.media }}

    <script src='{% static "vendor/dropzone/dropzone.min.js" %}'></script>

    <script type="text/javascript">
        // Camelized version of the HTML element's ID
        const form_params = {
            "policy": "{{ s3_form_policy }}",
            "x-amz-algorithm": "AWS4-HMAC-SHA256",
            "x-amz-credential": "{{ s3_form_credential }}",
            "x-amz-date": "{{ s3_form_date }}",
            "x-amz-signature": "{{ s3_form_signature }}"
        };
        const resume_config = {
            url: "{{ s3_form_endpoint }}",
            maxFilesize: {{ s3_max_file_size }}, // MB
            timeout: {{ s3_upload_timeout }}, // default 3000, in ms
            maxFiles: {{ s3_max_files }},
            acceptedFiles: "{{ s3_allowed_mime_types }}",
            addRemoveLinks: true,
            dictDefaultMessage: "Glissez-déposez un fichier ou cliquez ici",
            dictFallbackMessage: "Ce navigateur n'est pas compatible",
            dictFileTooBig: "Fichier trop volumineux",
            dictInvalidFileType: "Type de fichier non pris en charge",
            dictResponseError: "Erreur \{\{ statusCode \}\}",
            dictCancelUpload: "Annuler",
            dictUploadCanceled: "Annulé",
            dictCancelUploadConfirmation: "Voulez-vous vraiment annuler le transfert ?",
            dictRemoveFile: "Supprimer",
            dictRemoveFileConfirmation: "Voulez-vous vraiment supprimer le fichier ?",
            dictMaxFilesExceeded: "Un seul fichier autorisé à la fois",
            params: form_params,
            renameFile: function (file) {
                const extension = file.name.split('.').pop();
                const filename = Dropzone.uuidv4();
                const file_key = `{{ s3_key_path }}/${filename}.${extension}`;
                // Set the filekey before sending the form!
                // window.essai = this;
                this.params.append("key", file_key);
                // file.formData.append("key", filekey);
                // $("input#file_key").val(file_key);
                return file_key;
            },
            success: function(file) {
                // Sadly, our S3 provider does not return the "Location" header.
                // Don't forget to add "Location" to CORS' exposed headers!
                // const location = file.xhr.getResponseHeader("Location");
                const location = `{{ s3_form_endpoint }}/${file.upload.filename}`;
                {% if ITOU_ENVIRONMENT == "DEV" %}
                    console.log(location);
                {% endif %}
                $("input#id_resume_link").val(location);
            },
        };
        Dropzone.autoDiscover = false;
        $("#resume_form").dropzone(resume_config);

        //  Dropzone.options.resumeForm = {
        //     url: "{{ s3_form_endpoint }},"
        //     maxFilesize: {{ s3_max_file_size }}, // MB
        //     timeout: {{ s3_upload_timeout }}, // default 3000, in ms
        //     maxFiles: {{ s3_max_files }},
        //     acceptedFiles: "{{ s3_allowed_mime_types }}",
        //     addRemoveLinks: true,
        //     dictDefaultMessage: "Glissez-déposez un fichier ou cliquez ici",
        //     dictFallbackMessage: "Ce navigateur n'est pas compatible",
        //     dictFileTooBig: "Fichier trop volumineux",
        //     dictInvalidFileType: "Type de fichier non pris en charge",
        //     dictResponseError: "Erreur \{\{ statusCode \}\}",
        //     dictCancelUpload: "Annuler",
        //     dictUploadCanceled: "Annulé",
        //     dictCancelUploadConfirmation: "Voulez-vous vraiment annuler le transfert ?",
        //     dictRemoveFile: "Supprimer",
        //     dictRemoveFileConfirmation: "Voulez-vous vraiment supprimer le fichier ?",
        //     dictMaxFilesExceeded: "Un seul fichier autorisé à la fois",
        //     params: {
        //         "policy": "{{ s3_form_policy }}",
        //         "x-amz-algorithm": "AWS4-HMAC-SHA256",
        //         "x-amz-credential": "{{ s3_form_credential }}",
        //         "x-amz-date": "{{ s3_form_date }}",
        //         "x-amz-signature": {{ s3_form_signature }}
        //     },
        //     renameFile: function (file) {
        //         const extension = file.name.split('.').pop();
        //         const filename = Dropzone.uuidv4();
        //         const file_key = `{{ s3_key_path }}/${filename}.${extension}`;
        //         // Set the filekey before sending the form!
        //         $("input#file_key").val(file_key);
        //         return file_key;
        //     },
        //     success: function(file) {
        //         // Sadly, our S3 provider does not return the "Location" header.
        //         // Don't forget to add "Location" to CORS' exposed headers!
        //         // const location = file.xhr.getResponseHeader("Location");
        //         const location = `{{ s3_form_endpoint }}/${file.upload.filename}`;
        //         {% if ITOU_ENVIRONMENT == "DEV" %}
        //             console.log(location);
        //         {% endif %}
        //         $("input#id_resume_link").val(location);
        //     },
        // };
    </script>
{% endblock %}
