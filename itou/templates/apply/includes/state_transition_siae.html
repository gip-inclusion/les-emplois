{% load bootstrap4 %}
{% load format_filters %}

{% if job_application.state.is_new %}

    <hr>

    <form method="post" action="{% url 'apply:process' job_application_id=job_application.id %}" class="js-prevent-multiple-submit">
        {% csrf_token %}
        {% buttons %}
            <p class="text-right">
                <button type="submit" class="btn btn-primary">J'étudie cette candidature</button>
            </p>
        {% endbuttons %}
    </form>

{% endif %}

{# Possible next steps when the state is processing ------------------------------------------------------ #}

{% if job_application.state.is_processing %}

    <hr>

    {% if job_application.eligibility_diagnosis_by_siae_required %}
        <p>{% include "eligibility/includes/new_diagnosis_button.html" %}</p>
    {% else %}
        <p>
            <a href="{% url 'apply:accept' job_application_id=job_application.id %}" class="btn btn-outline-success btn-block btn-ico">
                <span>Je l'embauche</span>
            </a>
        </p>

        <p>
            <a href="{% url 'apply:postpone' job_application_id=job_application.id %}" class="btn btn-outline-success btn-block btn-ico">
                <span>Mettre en liste d'attente</span>
            </a>
        </p>

    {% endif %}

    <p>
        <a href="{% url 'apply:refuse' job_application_id=job_application.id %}" class="btn btn-outline-danger btn-block btn-ico">
            <span>Décliner la candidature</span>
        </a>
    </p>

{% endif %}

{# Possible next steps when the state is postponed ------------------------------------------------------ #}

{% if job_application.state.is_postponed %}

    <hr>

    {% if job_application.eligibility_diagnosis_by_siae_required %}
        <p>{% include "eligibility/includes/new_diagnosis_button.html" %}</p>
    {% else %}
        <p>
            <a href="{% url 'apply:accept' job_application_id=job_application.id %}" class="btn btn-outline-success btn-block btn-ico">
                <span>Je l'embauche</span>
            </a>
        </p>
    {% endif %}

    <p>
        <a href="{% url 'apply:refuse' job_application_id=job_application.id %}" class="btn btn-outline-danger btn-block btn-ico">
            <span>Décliner la candidature</span>
        </a>
    </p>

{% endif %}


{# Possible next steps when the state is obsolete, refused or cancelled --------------------------------- #}

{% if job_application.state.is_obsolete or job_application.state.is_refused or job_application.state.is_cancelled %}

    <hr>

    {% if job_application.eligibility_diagnosis_by_siae_required %}
        <p>{% include "eligibility/includes/new_diagnosis_button.html" %}</p>
    {% else %}
        <p>
            <a href="{% url 'apply:accept' job_application_id=job_application.id %}" class="btn btn-outline-success btn-block btn-ico">
                <span>Je l'embauche</span>
            </a>
        </p>
    {% endif %}

{% endif %}

{# Job application accepted: details -------------------------------------------------------------------- #}

{% if job_application.state.is_accepted %}
    <hr>

    <h3 class="h2 font-weight-normal text-muted">Détails du contrat de travail</h3>
    <p>
        <ul>
            <li>Début : {{ job_application.hiring_start_at|date:"d F Y" }}</li>
            <li>Fin : {{ job_application.hiring_end_at|date:"d F Y"|default:"Non renseigné" }}</li>
        </ul>
    </p>

    {% if job_application.can_update_hiring_start %}
        <p>
            <a href="{% url 'apply:edit_contract_start_date' job_application_id=job_application.pk %}" class="btn btn-outline-primary btn-block">
                Modifier la période du contrat de travail
            </a>
        </p>
    {% endif %}

    {# Job application cancellation -------------------------------------------------------------------------- #}
    {% if job_application.can_be_cancelled %}
        <hr>

        <h3 class="h2 font-weight-normal text-muted">Rétractation</h3>

        {% if job_application.to_siae.is_subject_to_eligibility_rules %}
            <p>
                Si vous annulez cette embauche, vous ne pourrez pas prétendre à l'aide au poste pour les jours éventuellement travaillés.
            </p>
            <p>
                {{ job_application.job_seeker.get_full_name|title }} restera éligible à l'IAE et pourra de nouveau vous envoyer une candidature dans le futur.
            </p>
            <p>Si une fiche salarié a été saisie pour cette embauche, elle sera annulée.</p>
        {% endif %}
        <p>
            <a href="{% url 'apply:cancel' job_application_id=job_application.id %}" class="btn btn-danger btn-block text-decoration-none">Annuler l'embauche</a>
        </p>
    {% endif %}


{% endif %}

{# Job application archival -------------------------------------------------------------------- #}

{% if job_application.can_be_archived %}
    {% include "apply/includes/archive_button.html" with job_application=job_application %}
{% endif %}
