{% load badges %}
{% load enums %}
{% load matomo %}
{% load str_filters %}
{% enums "eligibility" "AuthorKind" as AuthorKind %}
{% enums "job_applications" "SenderKind" as SenderKind %}


{% if job_applications_list_kind is JobApplicationsListKind.SENT %}
    {% url 'apply:details_for_prescriber' job_application_id=job_application.id as details_url %}
{% elif job_applications_list_kind is JobApplicationsListKind.RECEIVED %}
    {% url 'apply:details_for_company' job_application_id=job_application.id as details_url %}
{% elif job_applications_list_kind is JobApplicationsListKind.SENT_FOR_ME %}
    {% url 'apply:details_for_jobseeker' job_application_id=job_application.id as details_url %}
{% endif %}

<tr class="align-top">
    {% if job_applications_list_kind is JobApplicationsListKind.RECEIVED %}
        <th scope="row" class="text-start w-50px">
            <input class="form-check-input" type="checkbox" name="selected-application" value="{{ job_application.pk }}" id="select-{{ job_application.pk }}" autocomplete="off">
            <label class="visually-hidden" for="select-{{ job_application.pk }}">Sélectionner cette candidature</label>
        </th>
    {% endif %}
    {% if job_applications_list_kind is JobApplicationsListKind.SENT_FOR_ME %}
        <td>
            <a class="btn-link d-block" href="{{ details_url }}?back_url={{ request.get_full_path|urlencode }}">
                {{ job_application.to_company.display_name }}
            </a>
            {% job_application_state_badge job_application extra_classes="badge-sm" %}
        </td>
    {% else %}
        <td>
            <a class="btn-link" href="{{ details_url }}?back_url={{ request.get_full_path|urlencode }}">
                {{ job_application.job_seeker.get_inverted_full_name|mask_unless:job_application.user_can_view_personal_information }}
            </a>
            <span class="d-block">
                {% if job_application.job_seeker.department %}{{ job_application.job_seeker.department }} -{% endif %}
                {{ job_application.job_seeker.city|title }}
            </span>
            {% job_application_state_badge job_application extra_classes="badge-sm" %}
        </td>
    {% endif %}

    <td>{{ job_application.created_at|date:"d/m/Y" }}</td>

    {% if job_applications_list_kind is JobApplicationsListKind.SENT %}
        <td>{{ job_application.to_company.display_name }}</td>
    {% endif %}

    <td>
        {% with all_jobs=job_application.selected_jobs.all %}
            {% if all_jobs|length == 0 %}
                Candidature spontanée
            {% else %}
                <ul class="list-unstyled">
                    {% for job in all_jobs %}<li>{{ job.display_name }}</li>{% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
    </td>
    <td>
        {% if request.user == job_application.sender %}
            Vous
        {% elif job_application.sender_kind == SenderKind.JOB_SEEKER %}
            <i class="ri-user-line me-1" aria-hidden="true"></i>Le candidat lui-même
        {% elif job_application.sender_kind == SenderKind.EMPLOYER %}
            <i class="ri-community-line" aria-hidden="true"></i>
            {{ job_application.sender_company.display_name }}
        {% elif job_application.sender_kind == SenderKind.PRESCRIBER %}
            <i class="ri-home-smile-2-line" aria-hidden="true"></i>
            {% if job_application.sender_prescriber_organization %}
                {{ job_application.sender_prescriber_organization.display_name }}
            {% else %}
                {{ job_application.sender.get_inverted_full_name }}
            {% endif %}
        {% endif %}
    </td>
    {% if job_applications_list_kind is JobApplicationsListKind.SENT or job_applications_list_kind is JobApplicationsListKind.RECEIVED and request.current_organization.is_subject_to_iae_rules %}
        {# prescription or received by IAE employer #}
        {% if job_applications_list_kind is JobApplicationsListKind.SENT and not job_application.to_company.is_subject_to_eligibility_rules %}
            <td>
                <i class="text-disabled">Candidature hors IAE</i>
            </td>
            <td>
                <i class="text-disabled">Candidature hors IAE</i>
            </td>
        {% else %}
            {# IAE (prescriptions and received) and GEIQ (prescriptions)  #}
            <td>
                {% if job_application.preloaded_administrative_criteria %}
                    <ul class="mb-0">
                        {% for criteria in job_application.preloaded_administrative_criteria %}<li>{{ criteria.name }}</li>{% endfor %}
                    </ul>
                    {% if job_application.preloaded_administrative_criteria_extra_nb %}
                        <span>+ {{ job_application.preloaded_administrative_criteria_extra_nb }} autres critères</span>
                    {% endif %}
                {% elif job_application.jobseeker_eligibility_diagnosis and job_application.jobseeker_eligibility_diagnosis_author_kind == AuthorKind.PRESCRIBER and not job_application.to_company.kind == "GEIQ" or job_application.jobseeker_geiq_eligibility_diagnosis and job_application.jobseeker_geiq_eligibility_diagnosis.author_kind == AuthorKind.PRESCRIBER and job_application.to_company.kind == "GEIQ" %}
                    Le prescripteur habilité n'a pas renseigné de critères.
                {% else %}
                    <i class="text-disabled">Aucun critère sélectionné</i>
                {% endif %}
            </td>
            <td>
                {% if job_application.to_company.is_subject_to_iae_rules %}
                    {% include "eligibility/includes/iae/eligibility_badge.html" with job_seeker=job_application.job_seeker eligibility_diagnosis=job_application.jobseeker_valid_eligibility_diagnosis force_valid_approval=False badge_size="badge-sm" only %}
                    {% if job_application.job_seeker.has_valid_approval %}
                        {% if job_application.job_seeker.latest_approval.eligibility_diagnosis %}
                            {% if job_application.job_seeker.latest_approval.eligibility_diagnosis.is_from_employer %}
                                {% if request.from_employer and job_application.job_seeker.latest_approval.eligibility_diagnosis.author_siae_id == request.current_organization.id %}
                                    <span class="d-block">Éligibilité validée par votre entreprise</span>
                                {% else %}
                                    <span class="d-block">Éligibilité validée par un employeur</span>
                                {% endif %}
                            {% else %}
                                <span class="d-block">Éligibilité validée par un prescripteur habilité</span>
                            {% endif %}
                        {% endif %}
                    {% elif job_application.jobseeker_valid_eligibility_diagnosis %}
                        {% if job_application.jobseeker_eligibility_diagnosis_author_kind == AuthorKind.PRESCRIBER %}
                            <span class="d-block">Éligibilité validée par un prescripteur habilité</span>
                        {% elif job_applications_list_kind is JobApplicationsListKind.SENT %}
                            <span class="d-block">Éligibilité validée par l’employeur</span>
                        {% else %}
                            <span class="d-block">Éligibilité validée par votre entreprise</span>
                        {% endif %}
                    {% else %}
                        <span class="d-block">Un diagnostic doit être réalisé</span>
                    {% endif %}
                {% else %}
                    {# GEIQ prescriptions #}
                    {% include "eligibility/includes/geiq/eligibility_badge.html" with job_seeker=job_application.job_seeker geiq_eligibility_diagnosis=job_application.jobseeker_geiq_eligibility_diagnosis badge_size="badge-sm" only %}
                    {% if job_application.jobseeker_geiq_eligibility_diagnosis %}
                        {# A prescription with an eligibility diagnosis for a GEIQ is necessarily done by an authorized prescriber #}
                        <span class="d-block">Diagnostic public prioritaire GEIQ validé par un prescripteur habilité</span>
                    {% else %}
                        <span class="d-block">Un diagnostic doit être réalisé</span>
                    {% endif %}
                {% endif %}
            </td>
        {% endif %}
    {% endif %}

    <td class="text-end w-50px align-middle">
        {% if job_applications_list_kind is JobApplicationsListKind.SENT %}
            <a class="btn btn-sm btn-link btn-ico-only"
               href="{{ details_url }}?back_url={{ request.get_full_path|urlencode }}"
               data-bs-toggle="tooltip"
               data-bs-title="Voir sa candidature"
               {% matomo_event "candidature" "clic" "voir_candidature_prescripteur" %}>
                <i class="ri-arrow-drop-right-line fs-lg" aria-label="Gérer la candidature de {{ job_application.job_seeker.get_inverted_full_name|mask_unless:job_application.user_can_view_personal_information }}"></i>
            </a>
        {% elif job_applications_list_kind is JobApplicationsListKind.RECEIVED %}
            <a class="btn btn-sm btn-link btn-ico-only"
               href="{{ details_url }}?back_url={{ request.get_full_path|urlencode }}"
               data-bs-toggle="tooltip"
               data-bs-title="Voir sa candidature"
               {% matomo_event "candidature" "clic" "voir-candidature-employeur" %}>
                <i class="ri-arrow-drop-right-line fs-lg" aria-label="Gérer la candidature de {{ job_application.job_seeker.get_inverted_full_name|mask_unless:job_application.user_can_view_personal_information }}"></i>
            </a>
        {% elif job_applications_list_kind is JobApplicationsListKind.SENT_FOR_ME %}
            <a class="btn btn-sm btn-link btn-ico-only" href="{{ details_url }}?back_url={{ request.get_full_path|urlencode }}" data-bs-toggle="tooltip" data-bs-title="Voir ma candidature">
                <i class="ri-arrow-drop-right-line fs-lg" aria-label="Voir ma candidature"></i>
            </a>
        {% endif %}
    </td>
</tr>
