{% extends "apply/submit/application/base.html" %}
{% load bootstrap4 %}
{% load static %}

{% block extra_head %}
    {{ block.super }}
    <!-- Dropzone -->
    <link rel="stylesheet" type="text/css" href='{% static "vendor/dropzone/dropzone.min.css" %}'>
{% endblock extra_head %}

{% block progress_title %}{{ block.super }} - Message & CV{% endblock %}
{% block step_title %}Finaliser la candidature{% endblock %}
{% block pre_step_title %}
    {% if is_subject_to_eligibility_rules %}
        {% if not request.user.kind == UserKind.JOB_SEEKER and eligibility_diagnosis.author_organization %}
            <div class="mb-5">
                <p>L’éligibilité à l'IAE du candidat a été validée par :</p>
                <p class="text-tertiary font-weight-bold">{{ eligibility_diagnosis.author_organization.display_name }}</p>
            </div>
        {% endif %}
        {# Nothing is displayed to SIAE members when the job seeker is not eligible to the IAE #}
        {% if request.user.kind != UserKind.SIAE_STAFF or job_seeker.has_valid_common_approval or eligibility_diagnosis %}
            <div class="alert alert-info mb-5" role="status">
                <div class="row">
                    <div class="col-auto pr-0">
                        <i class="ri-information-line ri-xl"></i>
                    </div>
                    <div class="col">
                        {% if job_seeker.has_valid_common_approval %}
                            <p class="mb-2">
                                <strong>Date de fin de validité du pass IAE : {{ job_seeker.latest_common_approval.end_at|date:"d/m/Y" }}</strong>
                            </p>
                            <p class="mb-0">
                                {% if request.user.is_prescriber_with_authorized_org or request.user.kind == UserKind.SIAE_STAFF %}
                                    Tant que le Pass IAE est valide, vous n’avez pas à valider la situation administrative du candidat.
                                {% elif request.user.kind == UserKind.PRESCRIBER %}
                                    Tant que le pass IAE est valide, l’employeur n’aura pas à vérifier l’éligibilité IAE du candidat.
                                {% elif request.user.kind == UserKind.JOB_SEEKER %}
                                    Tant que le pass IAE est valide, l’employeur n’aura pas à vérifier votre éligibilité à l’IAE.
                                {% endif %}
                            </p>
                        {% elif eligibility_diagnosis %}
                            <p class="mb-2">
                                <strong>Date de fin de validité du diagnostic : {{ eligibility_diagnosis.expires_at|date:"d/m/Y" }}</strong>
                            </p>
                            <p class="mb-0">
                                {% if request.user.kind == UserKind.PRESCRIBER %}
                                    Tant que l’éligibilité IAE est valide, l’employeur n’aura pas à vérifier les critères administratifs du candidat.
                                {% elif request.user.kind == UserKind.SIAE_STAFF %}
                                    Tant que l’éligibilité IAE est valide, vous n’aurez pas à vérifier les critères administratifs du candidat.
                                {% elif request.user.kind == UserKind.JOB_SEEKER %}
                                    Tant que votre éligibilité IAE est valide, l’employeur n’aura pas à vérifier vos critères administratifs.
                                {% endif %}
                            </p>
                        {% else %}
                            {% if request.user.kind == UserKind.PRESCRIBER %}
                                <p class="mb-2">
                                    <strong>Information</strong>
                                </p>
                                <p class="mb-0">En cas d’embauche, l’employeur se chargera de vérifier et valider l’éligibilité IAE du candidat.</p>
                            {% elif request.user.kind == UserKind.JOB_SEEKER %}
                                <p class="mb-2">
                                    <strong>Information</strong>
                                </p>
                                <p class="mb-0">En cas d’embauche, l’employeur se chargera de vérifier et valider votre éligibilité à l’IAE.</p>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}
{% endblock %}

{% block form_content %}
    {{ form.selected_jobs.as_hidden }}
    <div class="d-flex flex-column flex-lg-row">
        <div class="col-12 col-lg-7 pl-0">{% bootstrap_field form.message %}</div>
        <div>
            <div class="alert alert-primary bg-white mt-5 py-0" role="status">
                <div class="row">
                    <div class="col-auto pr-0">
                        <i class="ri-lightbulb-line ri-xl"></i>
                    </div>
                    <div class="col">
                        <p class="mb-2">
                            <strong>Bon à savoir</strong>
                        </p>
                        {% if request.user.kind == UserKind.SIAE_STAFF %}
                            <p class="mb-0">Précisez dans le message :</p>
                            <ul class="mb-0">
                                <li>les motivations du candidat,</li>
                                <li>ses compétences,</li>
                                <li>ses disponibilités</li>
                            </ul>
                        {% else %}
                            <p class="mb-0">
                                {% if request.user.kind == UserKind.JOB_SEEKER %}
                                    Pour retenir l’attention du recruteur, décrivez votre situation,
                                    votre parcours, vos compétences et expliquez les freins socio-professionnels rencontrés.
                                    <br />
                                    Vous pouvez vous appuyer sur le document
                                    <a class="text-important"
                                       href="{{ ITOU_COMMUNITY_URL }}/doc/emplois/diagnostic-socio-professionnel/"
                                       target="_blank"
                                       rel="noreferrer noopener"
                                       title="Diagnostic socio-professionnel des candidats (ouverture dans un nouvel onglet)">diagnostic socio-professionnel de référence</a>.
                                    <br />
                                    Précisez également dans le message, vos motivations, vos compétences, ainsi que vos disponibilités.
                                {% else %}
                                    Pour retenir l’attention du recruteur, décrivez la situation actuelle du candidat,
                                    son parcours, ses compétences et expliquez les freins socio-professionnels rencontrés.
                                    <br />
                                    Vous pouvez vous appuyer sur le document
                                    <a class="text-important"
                                       href="{{ ITOU_COMMUNITY_URL }}/doc/emplois/diagnostic-socio-professionnel/"
                                       target="_blank"
                                       rel="noreferrer noopener"
                                       title="Diagnostic socio-professionnel des candidats (ouverture dans un nouvel onglet)">diagnostic socio-professionnel de référence</a>.
                                    <br />
                                    Précisez également dans le message, ses motivations, ses compétences, ainsi que ses disponibilités.
                                {% endif %}
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-7 pl-0">
        <div class="form-group">
            <label for="resume_form" class="js-display-if-javascript-enabled">{{ form.resume_link.label }}</label>
            {{ form.resume_link.as_hidden }}
            {% include "storage/s3_upload_form.html" with dropzone_form_id="resume_form" %}
            {% if resume_is_recommended %}
                <div class="alert alert-warning" role="status">
                    <div class="row">
                        <div class="col-auto pr-0">
                            <i class="ri-information-line ri-xl text-warning"></i>
                        </div>
                        <div class="col">
                            <p class="mb-2">
                                <strong>Le CV est fortement recommandé</strong>
                            </p>
                            <p class="mb-0">
                                L’ajout du Curriculum Vitae (CV) est fortement recommandé pour que la candidature soit étudiée par ce recruteur.
                            </p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}


{% block script %}
    {{ block.super }}
    <!-- Dropzone -->
    <script src='{% static "vendor/dropzone/dropzone.min.js" %}'></script>
    <script src='{% static "js/s3_upload.js" %}'></script>
    {{ s3_upload.form_values|json_script:"s3-form-values" }}
    {{ s3_upload.config|json_script:"s3-upload-config" }}
    <script nonce="{{ CSP_NONCE }}">
        s3UploadInit({
            dropzoneSelector: "#resume_form",
            callbackLocationSelector: "#{{ form.resume_link.id_for_label }}",
            s3FormValuesId: "s3-form-values",
            s3UploadConfigId: "s3-upload-config",
            // Not really nice
            sentryInternalUrl: "{% url 'home:sentry_debug' %}",
            sentryCsrfToken: "{{ csrf_token }}"
        });
    </script>
{% endblock %}

{% block form_submit_button %}
    {% if request.user.kind == UserKind.SIAE_STAFF %}
        <button type="submit" class="btn btn-primary">Enregistrer</button>
    {% else %}
        <button type="submit" class="btn btn-primary">Envoyer la candidature</button>
    {% endif %}
{% endblock %}
