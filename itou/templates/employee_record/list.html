{% extends "layout/content.html" %}
{% load static %}
{% load format_filters %}
{% load list_filters %}
{% load bootstrap4 %}

{% block title %}Fiches salarié ASP - {{ current_siae.display_name }} {{ block.super }}{% endblock %}

{% block extra_head %}{{ filters_form.media.css }}{% endblock %}

{% block script %}
    {{ block.super }}
    <!-- Needed to use Select2MultipleWidget. -->
    {{ filters_form.media.js }}
    <script nonce="{{ CSP_NONCE }}">
        $("#status-filter-form :input").change(function () {
            $("#status-filter-form").submit();
        });
        $("#order-form-group :input").click(function(event) {
            let input = $("#id_order")
            input.val(event.target.value); // Fill the hidden order input of the form
            input.change(); // Fire a change event to notify handlers
        });
    </script>
{% endblock %}

{% block content %}

    <h1 class="h1-hero-c1">
        Fiches salarié ASP - <span class="text-muted">{{ current_siae.display_name }}</span>
    </h1>

    <div class="mt-3">
        <div class="row">

            <div class="col-12 col-md-4 mt-2">
                <form method="get" class="form" id="status-filter-form">
                    <div class="card c-card h-100 w-100 c-card--emploi">
                        <div class="card-header">
                            <h3>Filtrer les fiches</h3>
                        </div>
                        <div class="card-body">
                            {# Status filter #}
                            <div class="pt-3 w-100 border-bottom">
                                <span class="h5 mb-1">Par statut</span>
                            </div>
                            <div class="p-1">
                                <div class="container form-group m-0">
                                    {% for status, badge in form.status|zip:badges %}
                                        <div class="row">
                                            <div class="col-10 p-0">{{ status }}</div>
                                            <div class="col-2 p-0 text-right">
                                                <p class="small mb-0">
                                                    <span class="badge badge-pill badge-{{ badge.1 }}">{{ badge.0 }}</span>
                                                </p>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {# Job seeker filter #}
                            <div class="pt-3 w-100 border-bottom">
                                <span class="h5 mb-1">Par candidat</span>
                            </div>
                            <div class="p-1">{% bootstrap_field filters_form.job_seekers %}</div>
                            {# Filled via jQuery #}
                            {{ form.order.as_hidden }}
                        </div>
                    </div>
                </form>
            </div>
            <div class="col-12 col-md-8 mt-2">
                <div class="container rounded bg-gray-400 p-3 mb-3">
                    <div class="row">
                        <div class="col-sm-10">
                            <h5>Nous transférons vos fiches salarié à l'ASP afin de vous faire gagner du temps</h5>
                            <p class="mt-3">
                                Une fois envoyées et validées, vous retrouverez directement vos données sur
                                l'extranet de l'ASP.
                            </p>
                            <ul>
                                <li>
                                    Ne sont présentes dans cette liste que les candidatures acceptées (embauches) à
                                    partir du <b>{{ feature_availability_date|date }}</b>.
                                </li>
                                <li>
                                    Vous devez avoir une annexe financière valide dans l'extranet de l'ASP pour pouvoir
                                    déclarer une fiche salarié dans les emplois.
                                </li>
                            </ul>
                        </div>
                        <div class="col-sm-2 text-right">
                            <img src="{% static 'img/employee_record/asp_upload.svg' %}" alt="Transfert ASP" class="img-fluid" />
                        </div>
                    </div>
                </div>

                {# Messages #}
                <article>
                    {% if form.status.value == "NEW" %}
                        <p class="mb-0">
                            Vous trouverez ici les candidatures validées <b>à partir desquelles vous devez créer de
                            nouvelles fiches salarié</b>.
                        </p>
                    {% elif form.status.value == "READY" %}
                        <p class="mb-0">
                            Vous trouverez ici les fiches salarié complétées
                            <b>en attente d’envoi à l’ASP, qui a lieu automatiquement à intervalles réguliers</b>.
                        </p>
                        <p class="mb-0">
                            À ce stade, seule la visualisation des informations de la fiche est
                            possible.
                        </p>
                        <p class="mb-0">Merci de votre patience.</p>
                    {% elif form.status.value == "SENT" %}
                        <p class="mb-0">Vous trouverez ici les fiches salarié complétées et envoyées à l'ASP.</p>
                        <p class="mb-0">
                            À ce stade, et en attendant un retour de l'ASP, seule la visualisation des informations de
                            la fiche est possible.
                        </p>
                    {% elif form.status.value == "REJECTED" %}
                        <p class="mb-0">
                            Vous trouverez ici les fiches salarié envoyées à l'ASP et retournées avec une
                            erreur.
                        </p>
                        <p class="mb-0">Vous pouvez modifier les fiches en erreur et les envoyer à nouveau.</p>
                    {% elif form.status.value == "PROCESSED" %}
                        <p class="mb-0">Vous trouverez ici les fiches salarié envoyées et validées par l'ASP.</p>
                        <p class="mb-0">
                            Aucune action ultérieure n'est possible à ce stade, mais vous pouvez consulter le détail de
                            la fiche salarié.
                        </p>
                    {% elif form.status.value == "DISABLED" %}
                        <p class="mb-0">Vous trouverez ici les fiches salarié que vous avez désactivées.</p>
                        <p class="mb-0">
                            En cas de besoin vous pouvez réactiver une fiche, elle sera transférée dans la catégorie
                            "Nouvelle".
                        </p>
                    {% endif %}
                </article>
                {% if need_manual_regularization %}
                    <div class="alert alert-warning my-5">
                        <div class="row">
                            <div class="col-auto pr-0">
                                <i class="ri-error-warning-line ri-xl text-danger"></i>
                            </div>
                            <div class="col">
                                <p class="mb-2">
                                    <strong>Une action de votre part est nécessaire</strong>
                                </p>
                                <p class="mb-0">
                                    Attention, nous avons détecté une ou plusieurs fiches salariés qui nécessitent une régularisation manuelle de votre part.
                                </p>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <div class="row justify-content-end">
                    <div class="col-12 col-sm-auto">
                        <span class="font-weight-bold mr-2">Trier par</span>
                        <button type="button" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            {{ ordered_by_label }}
                        </button>
                        <div class="dropdown-menu dropdown-menu-right" id="order-form-group">
                            {% for order_value, order_label in form.order.field.choices %}
                                <button class="dropdown-item {% if order_value == form.order.value %}active{% endif %}" type="button" value="{{ order_value }}">
                                    {{ order_label }}
                                </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {# "Real" employee records objects #}
                <div class="employee-records-list">
                    {% if employee_records_list %}
                        {% for employee_record in navigation_pages %}
                            {% with item=employee_record.job_application %}
                                {% include "employee_record/includes/list_item.html" %}
                            {% endwith %}
                        {% endfor %}
                        {# New employee records i.e. job applications #}
                    {% else %}
                        {% for item in navigation_pages %}
                            {% include "employee_record/includes/list_item.html" %}
                        {% endfor %}
                    {% endif %}
                </div>

                {% if not navigation_pages %}
                    <div class="text-muted text-center mt-5">
                        <i class="ri-forbid-line mr-1"></i>
                        <span>Aucune fiche salarié avec le statut sélectionné ...</span>
                    </div>
                {% endif %}

                {% include "includes/pagination.html" with page=navigation_pages %}

            </div>
        </div>
    </div>

{% endblock %}
