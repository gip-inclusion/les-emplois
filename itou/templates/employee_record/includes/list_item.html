{% load format_filters %}
{% load tally %}
<div class="c-card card has-links-inside my-3 my-md-4">
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-12 col-md">
                <h3 class="h3 m-0">{{ item.job_seeker.get_full_name }}</h3>
            </div>
            {# Statuses #}
            <div class="col-12 col-md-auto">
                {% if form.status.value == "SENT" %}
                    <span class="badge rounded-pill badge-sm bg-warning">
                        Transmise à l'ASP le {{ employee_record.updated_at|date:"SHORT_DATETIME_FORMAT" }}
                    </span>
                {% elif form.status.value == "REJECTED" %}
                    <span class="badge rounded-pill badge-sm bg-danger">
                        Retour en erreur le {{ employee_record.updated_at|date:"SHORT_DATETIME_FORMAT" }}
                    </span>
                {% elif form.status.value == "PROCESSED" %}
                    <span class="badge rounded-pill badge-sm bg-success">
                        Intégrée ASP le {{ employee_record.updated_at|date:"SHORT_DATETIME_FORMAT" }}
                    </span>
                {% elif form.status.value == "READY" %}
                    <span class="badge rounded-pill badge-sm bg-secondary">
                        Complétée le {{ employee_record.updated_at|date:"SHORT_DATETIME_FORMAT" }}
                    </span>
                {% elif form.status.value == "DISABLED" %}
                    <span class="badge rounded-pill badge-sm bg-emploi-lightest">
                        Désactivée le {{ employee_record.updated_at|date:"SHORT_DATETIME_FORMAT" }}
                    </span>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <ul class="list-unstyled fs-sm">
                    <li>
                        Numéro de PASS IAE : <b>{{ item.approval.number|format_approval_number }}</b>
                    </li>
                    <li>
                        Date de début : <b>{{ item.approval.start_at|date:"d/m/Y" }}</b>
                    </li>
                    <li>
                        Date de fin prévisionnelle : <b>{{ item.approval.end_at|date:"d/m/Y" }}</b>
                    </li>
                </ul>
            </div>
        </div>

        {# ASP error #}
        {% if form.status.value == "REJECTED" %}
            <div class="alert alert-warning">
                <p class="mb-0">
                    <b>Informations sur l'erreur de traitement :</b>
                </p>
                {% if employee_record.asp_processing_code == "3308" %}
                    <p class="mb-0">
                        Il semblerait que la commune de naissance sélectionnée ne corresponde pas au département de naissance choisi.
                    </p>
                    <p class="mb-0">
                        Si vous ne trouvez pas la commune de naissance que vous souhaitez renseigner dans le menu déroulant, renseignez une autre ville de naissance pour débloquer le transfert.
                    </p>
                    <p class="mb-0">
                        Vous pourrez ensuite modifier cette information dans l’Extranet IAE 2.0 de l’ASP une fois la fiche transmise.
                    </p>
                    <small>(Erreur {{ employee_record.asp_processing_code }})</small>
                {% elif employee_record.asp_processing_code == "3417" %}
                    <p class="mb-0">La commune de résidence du salarié n’est pas référencée dans l'Extranet IAE 2.0 de l'ASP.</p>
                    <p class="mb-0">Pour débloquer le transfert vous pouvez renseigner l’adresse postale de votre structure.</p>
                    <p class="mb-0">
                        Vous pourrez ensuite modifier cette information dans l’Extranet IAE 2.0 de l’ASP une fois la fiche transmise.
                    </p>
                    <small>(Erreur {{ employee_record.asp_processing_code }})</small>
                {% elif employee_record.asp_processing_code == "3435" %}
                    <p class="mb-0">
                        Nous n’avons pas encore reçu d’annexe financière à jour pour votre structure. Nous ne pouvons donc pas transmettre votre fiche salarié à l’ASP.
                    </p>
                    <p class="mb-0">
                        Pour résoudre ce problème, rendez-vous dans l’ASP et vérifiez que votre annexe financière “valide” ou “provisoire” est à jour.
                    </p>
                    <p class="mb-0">Si c’est le cas, patientez une semaine, et tentez de renvoyer la fiche salarié.</p>
                    <p>
                        Si elle n’est pas à jour, demandez à votre DDETS de la mettre à jour dans l’ASP, et patientez une semaine le temps que nous recevions l’information avant de tenter le renvoi de la fiche salarié.
                    </p>
                    <p class="mb-0">
                        Vous pouvez vérifier vos annexes financières de rattachement dans votre tableau de bord, rubrique “Annexes financières” en bas à gauche.
                    </p>
                    <small>(Erreur {{ employee_record.asp_processing_code }})</small>
                {% elif employee_record.asp_processing_code == "3436" %}
                    <p class="mb-0">La fiche salarié associée à ce PASS IAE et à votre SIRET a déjà été intégrée à l’ASP.</p>
                    <p class="mb-0">Connectez-vous à l’ASP pour la retrouver et déclarer les contrats associés.</p>
                    <p class="mb-0">
                        Si vos SIAE ont un SIRET commun pour 2 mesures, que vous avez déjà créé cette fiche salarié pour l’une des 2 mesures, vous devez vous rendre dans l’ASP pour gérer les autres contrats associés à ce PASS IAE.
                    </p>
                    <p class="mb-0">
                        Pour changer de mesure, créez directement un nouveau contrat dans l’ASP et sélectionnez la bonne mesure.
                    </p>
                    <small>(Erreur {{ employee_record.asp_processing_code }})</small>
                {% else %}
                    <p class="mb-0">
                        Erreur {{ employee_record.asp_processing_code }} :&nbsp;<small>{{ employee_record.asp_processing_label }}</small>
                    </p>
                {% endif %}
            </div>
        {% endif %}

        {# Actions #}
        {% if form.status.value == "NEW" %}
            {% if item.job_seeker.lack_of_nir_reason == "NIR_ASSOCIATED_TO_OTHER" %}
                <div class="alert alert-warning" role="status">
                    <div class="row">
                        <div class="col-auto pe-0">
                            <i class="ri-error-warning-line ri-xl text-warning"></i>
                        </div>
                        <div class="col">
                            <p class="mb-2">
                                <strong>Informations manquantes</strong>
                            </p>
                            <p class="mb-0">Pour créer cette fiche salarié, veuillez demander la régularisation du numéro de sécurité sociale.</p>
                        </div>
                        <div class="col-auto align-self-center">
                            <a class="btn btn-sm btn-primary" href="{% tally_form_url "wzxQlg" %}{{ item.nir_tally_params }}" target="_blank" rel="noopener">Régulariser le n° de sécurité sociale</a>
                        </div>
                    </div>
                </div>
            {% elif item.has_suspension or item.has_prolongation %}
                <div class="alert alert-warning" role="status">
                    <div class="row">
                        <div class="col-auto pe-0">
                            <i class="ri-error-warning-line ri-xl text-warning"></i>
                        </div>
                        <div class="col">
                            <p class="mb-2">
                                <strong>Une action de votre part est nécessaire</strong>
                            </p>
                            <p class="mb-0">
                                La nouvelle date de fin du PASS IAE n’a pas pu être transmise automatiquement à l’Extranet IAE 2.0 de l’ASP.
                                Une mise à jour manuelle est nécessaire même si ce salarié a déjà quitté la structure.
                            </p>
                        </div>
                        <div class="col-auto align-self-center">
                            <a class="btn btn-sm btn-primary" href="{% url "employee_record_views:create" item.id %}">Mettre à jour</a>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-end">
                    {% if item.employee_record_new %}
                        <a href="{% url "employee_record_views:disable" item.employee_record_new.id %}" class="btn btn-sm btn-outline-primary mt-2">Désactiver la fiche salarié</a>
                    {% endif %}
                    <a href="{% url "employee_record_views:create" item.id %}?from_status=NEW" class="btn btn-sm btn-outline-primary mt-2">Créer la fiche salarié</a>
                </div>
            {% endif %}
        {% else %}
            <div class="text-end">
                {% if form.status.value == "REJECTED" or form.status.value == "PROCESSED" %}
                    <a href="{% url "employee_record_views:disable" employee_record.id %}" class="btn btn-sm btn-outline-primary mt-2">Désactiver la fiche salarié</a>
                {% endif %}
                {% if form.status.value == "REJECTED" %}
                    <a href="{% url "employee_record_views:create" item.id %}?from_status=REJECTED" class="btn btn-sm btn-outline-primary mt-2">Modifier la fiche salarié</a>
                {% endif %}
                {% if form.status.value and form.status.value != "REJECTED" and form.status.value != "DISABLED" %}
                    <a href="{% url "employee_record_views:summary" employee_record.id %}" class="btn btn-sm btn-outline-primary mt-2">Voir le détail de la fiche salarié</a>
                {% endif %}
                {% if form.status.value == "DISABLED" %}
                    <a href="{% url "employee_record_views:reactivate" employee_record.id %}" class="btn btn-sm btn-outline-primary mt-2">Réactiver la fiche salarié</a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
