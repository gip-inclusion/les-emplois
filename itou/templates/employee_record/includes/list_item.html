{% load format_filters %}
<div class="card my-5">

    <div class="card-header">
        <h3 class="h2">{{ item.job_seeker.get_full_name|title }}</h3>
    </div>

    <div class="card-body">
        <div class="row">
            <div class="col-md-7">
                <p class="m-0">
                    Début de contrat :&nbsp;<b>{{ item.hiring_start_at|default_if_none:"Non renseigné" }}</b>
                </p>
                <p class="m-0">
                    Fin de contrat :&nbsp;<b{% if item.has_outdated_date %} class="text-danger"{% endif %}>{{ item.hiring_end_at|default_if_none:"Non renseigné" }}</b>
                    {% if item.has_outdated_date %}<i class="ri-error-warning-fill ri-xl text-danger align-text-bottom"></i>{% endif %}
                </p>
                <p class="m-0">
                    Numéro de PASS IAE (agrément) :&nbsp;<b>{{ item.approval.number|format_approval_number }}</b>
                </p>
            </div>

            {# Statuses #}
            <div class="col-md-5 text-right">
                <p class="small mb-0">
                    {% if form.status.value == "SENT" %}
                        <p class="badge badge-warning">
                            Transmise à l'ASP le&nbsp;<b>{{ employee_record.updated_at }}</b>
                        </p>
                    {% elif form.status.value == "REJECTED" %}
                        <p class="badge badge-danger">
                            Retour en erreur le&nbsp;<b>{{ employee_record.updated_at }}</b>
                        </p>
                    {% elif form.status.value == "PROCESSED" %}
                        <p class="badge badge-success">
                            Intégrée ASP le&nbsp;<b>{{ employee_record.updated_at }}</b>
                        </p>
                    {% elif form.status.value == "READY" %}
                        <p class="badge badge-secondary">
                            Complétée le&nbsp;<b>{{ employee_record.updated_at }}</b>
                        </p>
                    {% elif form.status.value == "DISABLED" %}
                        <p class="badge badge-emploi-lightest">
                            Désactivée le&nbsp;<b>{{ employee_record.updated_at }}</b>
                        </p>
                    {% endif %}
                </p>
            </div>
        </div>

        {# ASP error #}
        {% if form.status.value == "REJECTED" %}
            <div class="my-3 alert alert-emploi">
                <p>
                    <b>Informations sur l'erreur de traitement :</b>
                </p>
                {% if employee_record.asp_processing_code == "3308" %}
                    <p>Il semblerait que la commune de naissance sélectionnée ne corresponde pas au département de naissance choisi.</p>
                    <p>
                        Si vous ne trouvez pas la commune de naissance que vous souhaitez renseigner dans le menu déroulant, renseignez une autre ville de naissance pour débloquer le transfert.
                    </p>
                    <p>Vous pourrez ensuite modifier cette information dans l’Extranet IAE 2.0 de l’ASP une fois la fiche transmise.</p>
                    <small>(Erreur {{ employee_record.asp_processing_code }})</small>
                {% elif employee_record.asp_processing_code == "3417" %}
                    <p>L’adresse renseignée n’est pas référencée.</p>
                    <p>Renseignez l’adresse postale de votre structure pour débloquer le transfert.</p>
                    <p>Vous pourrez ensuite modifier cette information dans l’Extranet IAE 2.0 de l’ASP une fois la fiche transmise.</p>
                    <small>(Erreur {{ employee_record.asp_processing_code }})</small>
                {% elif employee_record.asp_processing_code == "3435" %}
                    <p>
                        Nous n’avons pas encore reçu d’annexe financière à jour pour votre structure. Nous ne pouvons donc pas transmettre votre fiche salarié à l’ASP.
                    </p>
                    <p>
                        Pour résoudre ce problème, rendez-vous dans l’ASP et vérifiez que votre annexe financière “valide” ou “provisoire” est à jour.
                    </p>
                    <p>Si c’est le cas, patientez une semaine, et tentez de renvoyer la fiche salarié.</p>
                    <p>
                        Si elle n’est pas à jour, demandez à votre DDETS de la mettre à jour dans l’ASP, et patientez une semaine le temps que nous recevions l’information avant de tenter le renvoi de la fiche salarié.
                    </p>
                    <p>
                        Vous pouvez vérifier vos annexes financières de rattachement dans votre tableau de bord, rubrique “Annexes financières” en bas à gauche.
                    </p>
                    <small>(Erreur {{ employee_record.asp_processing_code }})</small>
                {% elif employee_record.asp_processing_code == "3436" %}
                    <p>La fiche salarié associée à ce PASS IAE et à votre SIRET a déjà été intégrée à l’ASP.</p>
                    <p>Connectez-vous à l’ASP pour la retrouver et déclarer les contrats associés.</p>
                    <p>
                        Si vos SIAE ont un SIRET commun pour 2 mesures, que vous avez déjà créé cette fiche salarié pour l’une des 2 mesures, vous devez vous rendre dans l’ASP pour gérer les autres contrats associés à ce PASS IAE.
                    </p>
                    <p>Pour changer de mesure, créez directement un nouveau contrat dans l’ASP et sélectionnez la bonne mesure.</p>
                    <small>(Erreur {{ employee_record.asp_processing_code }})</small>
                {% else %}
                    <p>
                        Erreur {{ employee_record.asp_processing_code }} :&nbsp;<small>{{ employee_record.asp_processing_label }}</small>
                    </p>
                {% endif %}
            </div>
        {% endif %}

        {# Actions #}
        {% if form.status.value == "NEW" %}
            {% if item.has_outdated_date %}
                <div class="alert alert-danger mt-4" role="status">
                    <div class="row">
                        <div class="col-auto pr-0">
                            <i class="ri-error-warning-fill ri-xl text-danger"></i>
                        </div>
                        <div class="col">
                            <p class="mb-2">
                                <strong>Attention, une action de votre part est requise</strong>
                            </p>
                            <p class="mb-0">
                                La nouvelle date de fin du PASS IAE n’a pas pu être transmise à l’Extranet IAE 2.0 de l’ASP. Une mise à jour manuelle est nécessaire.
                            </p>
                        </div>
                        <div class="col-auto align-self-center">
                            <a class="btn btn-primary" href="{% url "employee_record_views:create" item.id %}">Mettre à jour</a>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-right">
                    {% if item.employee_record_new %}
                        <a href="{% url "employee_record_views:disable" item.employee_record_new.id %}?status=NEW" class="btn btn-outline-primary mt-2">Désactiver la fiche salarié</a>
                    {% endif %}
                    <a href="{% url "employee_record_views:create" item.id %}" class="btn btn-outline-primary mt-2">Créer la fiche salarié</a>
                </div>
            {% endif %}
        {% elif form.status.value == "READY" %}
            <div class="text-right">
                <a href="{% url "employee_record_views:summary" employee_record.id %}?status=READY" class="btn btn-outline-primary mt-2">Voir le détail de la fiche salarié</a>
            </div>
        {% elif form.status.value == "SENT" %}
            <div class="text-right">
                <a href="{% url "employee_record_views:summary" employee_record.id %}?status=SENT" class="btn btn-outline-primary mt-2">Voir le détail de la fiche salarié</a>
            </div>
        {% elif form.status.value == "REJECTED" %}
            <div class="text-right">
                <a href="{% url "employee_record_views:disable" employee_record.id %}?status=REJECTED" class="btn btn-outline-primary mt-2">Désactiver la fiche salarié</a>
                <a href="{% url "employee_record_views:create" item.id %}" class="btn btn-outline-primary mt-2">Modifier la fiche salarié</a>
            </div>
        {% elif form.status.value == "PROCESSED" %}
            <div class="text-right">
                <a href="{% url "employee_record_views:disable" employee_record.id %}?status=PROCESSED" class="btn btn-outline-primary mt-2">Désactiver la fiche salarié</a>
                <a href="{% url "employee_record_views:summary" employee_record.id %}?status=PROCESSED" class="btn btn-outline-primary mt-2">Voir le détail de la fiche salarié</a>
            </div>
        {% elif form.status.value == "DISABLED" %}
            <div class="text-right">
                <a href="{% url "employee_record_views:reactivate" employee_record.id %}" class="btn btn-outline-primary mt-2">Réactiver la fiche salarié</a>
            </div>
        {% endif %}
    </div>
</div>
