{% load dora %}
{% load markdownify %}
{% load str_filters %}

<div id="services-search-results">
    {% for service in results %}
        <div class="c-box c-box--results has-one-link-inside mb-3 mb-md-4">
            <div class="c-box--results__header">
                <div class="c-box--results__summary">
                    <i class="ri-community-line" aria-hidden="true"></i>
                    <div>
                        <span>{{ service.structure.nom }}</span>
                        <h3>{{ service.nom }}</h3>
                    </div>
                </div>
                <div class="d-flex flex-column flex-md-row gap-2 align-items-md-end gap-md-3">
                    <ul class="c-box--results__list-contact flex-md-grow-1 mt-2 mb-2 mb-md-0">
                        {% if service.code_postal and service.commune %}
                            <li>
                                <i class="ri-map-pin-2-line fw-normal me-1" aria-hidden="true"></i>
                                <address class="m-0">
                                    {% if service.adresse %}
                                        {{ service.adresse }}, {{ service.code_postal }} {{ service.commune }}
                                    {% else %}
                                        {{ service.code_postal }} {{ service.commune }}
                                    {% endif %}
                                </address>
                            </li>
                        {% endif %}
                    </ul>
                    <div class="mt-md-1">
                        <a href="{% dora_service_url service mtm_campaign="lesemplois" mtm_kwd="rechservice-accueil" %}"
                           class="btn btn-outline-primary btn-block w-100 w-md-auto white-space-nowrap stretched-link"
                           target="_blank"
                           rel="noopener"
                           aria-label="Voir la fiche de {{ service.structure.nom }} sur DORA (ouverture dans un nouvel onglet)">
                            <span>Voir la fiche détaillée</span>
                            <i class="ri-external-link-line fw-normal ms-2" aria-hidden="true"></i>
                        </a>
                    </div>
                </div>
            </div>
            <hr class="m-0">
            <div class="c-box--results__body">
                <p class="mb-2">{{ service.description|markdownify|striptags|shorten:200 }}</p>
                <span class="badge badge-xs rounded-pill bg-light text-primary">Source : {{ service.source }}, via data·inclusion</span>
            </div>
        </div>
    {% empty %}
        {% if api_error %}
            <div class="c-box c-box--results mb-3 mb-md-4">
                <div class="c-box--results__body">
                    <div class="alert alert-warning show" role="status">
                        <div class="row">
                            <div class="col-auto pe-0">
                                <i class="ri-information-line ri-xl text-warning" aria-hidden="true"></i>
                            </div>
                            <div class="col">
                                <p class="mb-0">
                                    Une erreur est survenue lors de l'appel à <a href="https://data.inclusion.gouv.fr/" target="_blank" rel="noopener" class="has-external-link">data·inclusion</a>. Veuillez réessayer ultérieurement.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="c-box c-box--results mb-3 mb-md-4">
                <div class="c-box--results__body">
                    <p class="mb-0">Aucun résultat avec les filtres actuels.</p>
                </div>
            </div>
        {% endif %}
    {% endfor %}

    {% include "includes/pagination.html" with page=results boost=True boost_indicator="#services-search-results" request=request only %}
</div>

{% if request.htmx and not request.htmx.boosted %}
    {% include "search/services/includes/summary.html" %}
{% endif %}
