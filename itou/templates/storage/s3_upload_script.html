{% load static %}

<script src='{% static "vendor/dropzone/dropzone.min.js" %}'></script>

<script type="text/javascript">
    // Input field where the location URL will be provided after success.
    const callback_location_selector = "#{{ callback_location_selector_id }}";

    // Transform this element into a drag and drop zone.
    const dropzone_selector = "#{{ dropzone_selector_id }}";

    // When a file is added to the drop zone, send a POST request to this URL.
    const form_url = "{{ s3_form_values.endpoint }}";

    // Submit button to be disabled during file processing
    const submit_button = $("button[type='submit']");

    // S3 form params sent when a new file is added to the drop zone.
    const form_params = {
        "policy": "{{ s3_form_values.encoded_policy }}",
        "x-amz-algorithm": "AWS4-HMAC-SHA256",
        "x-amz-credential": "{{ s3_form_values.credential_url }}",
        "x-amz-date": "{{ s3_form_values.date }}",
        "x-amz-signature": "{{ s3_form_values.signature }}"
    };

    // Appended before the file name. The final slash is added later.
    const key_path = "{{ s3_upload_config.key_path }}";

    // Dropzone configuration
    const dropzone_config = {
        url: form_url,
        params: form_params,
        maxFilesize: "{{ s3_upload_config.max_file_size }}", // in MB
        timeout: "{{ s3_upload_config.timeout }}", // default 3000, in ms
        maxFiles: "{{ s3_upload_config.max_files }}",
        acceptedFiles: "{{ s3_upload_config.allowed_mime_types }}",
        addRemoveLinks: true,
        // translations
        dictFallbackMessage: "Ce navigateur n'est pas compatible",
        dictFileTooBig: "Fichier trop volumineux",
        dictInvalidFileType: "Type de fichier non pris en charge",
        dictResponseError: "Erreur technique",
        dictCancelUpload: "Annuler",
        dictUploadCanceled: "Annulé",
        dictCancelUploadConfirmation: "Voulez-vous vraiment annuler le transfert ?",
        dictRemoveFile: "Supprimer",
        dictRemoveFileConfirmation: "Voulez-vous vraiment supprimer le fichier ?",
        dictMaxFilesExceeded: "Un seul fichier autorisé à la fois",
        // the function will be used to rename the file.name before appending it to the formData
        renameFile: function (file) {
            const extension = file.name.split('.').pop();
            const filename = Dropzone.uuidv4();
            const file_key = `${key_path}/${filename}.${extension}`;
            // Add a file key to options params so that it's send
            // as an input field on POST.
            // Careful: it should be the last form item to comply with S3 rules!
            this.params["key"] = file_key;
            return file_key;
        },
    };

    // By default, Dropzone attaches to any component having the "dropzone" class.
    // Turn off this behavior to control all the aspects "manually".
    Dropzone.autoDiscover = false;

    const dropzone = new Dropzone(dropzone_selector, dropzone_config);

    // Display a help message when the user tries to
    // submit the form during file transfer.
    submit_button.tooltip({"title": "Merci d'attendre la fin du transfert"});
    // Enable it later, during file transfer.
    submit_button.tooltip('disable');

    // Events
    dropzone.on("addedfile", function(file) {
        submit_button.tooltip('enable');
        submit_button.prop("disabled", true);
        submit_button.addClass("btn-secondary");
    });

    // Called when the upload was either successful or erroneous.
    dropzone.on("complete", function(file) {
        submit_button.tooltip('disable');
        submit_button.prop("disabled", false);
        submit_button.removeClass("btn-secondary");
    });

    dropzone.on("removedfile", function(file) {
        $(callback_location_selector).val("");
    });

    dropzone.on("success", function(file, xhr, formData) {
        const location = `${form_url}/${file.upload.filename}`;
        {% if ITOU_ENVIRONMENT == "DEV" %}
            console.log(location);
        {% endif %}

        // Prevent a selector mistake from being silent.
        if ($(callback_location_selector).length == 0) {
            alert("Ce document n'a pas pu être envoyé à cause d'un problème technique. Nous vous invitons à contacter notre support.");
            return false;
        }
        $(callback_location_selector).val(location);
    });

    dropzone.on("error", function(file, errorMessage, xhr) {
        if (xhr != null) {
            // An error occurred with the request.
            // Send it to Sentry to avoid silent bugs.
            const errorMessage = `Upload failed for Dropzone selector ${dropzone_selector} to S3 bucket ${form_url}`;
            $.post("{% url 'home:sentry_debug' %}", {
                "status_code": 500 , "error_message": errorMessage, "csrfmiddlewaretoken": '{{ csrf_token }}'
            });
        };
    });
</script>
