{% extends "layout/content_small.html" %}
{% load format_filters %}
{% load bootstrap4 %}
{% load static %}

{% block title %}{{ institution.name }} Sélectionner l'échantillon {{ block.super }}{% endblock %}

{% block content %}
    <div class="card c-card mt-4 p-3">
        <div class="card-body">

            <p class="h1">
                Sélectionner l'échantillon
            </p>
            <p class="h2">
                Contrôle a posteriori des auto-prescriptions faites par les SIAE
            </p>
            <p class="h3">
                Sélection des structures à contrôler
            </p>
            <p>
                Par défaut, un contrôle de 30% des SIAE ayant auto-prescrit a été défini au niveau national.
                Ce ratio est adaptable au niveau local entre {{ min }}% et {{ max }}%.
            </p>
            <p>
                Au niveau régional, la DREETS peut adapter la consigne de contrôle pour prendre en compte
                les moyens de chaque DDETS. La DDETS gère directement les paramètres de contrôle qu'elle souhaite
                obtenir dans le cadre des consignes nationales et régionales.
            </p>


            <p>
                Pour faciliter cette prise de décision, nous vous donnons un accès à l'ensemble des auto-prescriptions
                faites par les SIAE de votre territoire:
            </p>
            <p class="font-weight-bold">
                Données du contrôle a posteriori pour la période du {{evaluation_campaign.evaluated_period_start_at|date:"d F Y"}} au {{evaluation_campaign.evaluated_period_end_at|date:"d F Y"}}
            </p>
            <p>
                <a class="btn btn-outline-primary" href="{% url 'stats:stats_ddets_diagnosis_control' %}{% if back_url %}?back_url={{ back_url }}{% endif %}" title="Voir les données">
                    Voir les données
                </a>
            </p>

            <p class="h3">
                Sélection des salariés à contrôler
            </p>
            <p>
                Pour chacune des SIAE à contrôler, nous effectuerons une sélection aléatoire de 20% des recrutements en auto-prescription
                (entre 2 et 20 dossiers maximum).
            </p>
            <p>
                <div class="alert alert-info" role="status">
                    <p class="font-weight-bold">Exemple</p>
                    <p>Si une ETTI de votre territoire a fait 270 auto-prescriptions, vous devrez en contrôler seulement 20 au lieu de 54 (20% de 270)</p>
                </div>
            </p>
            <p class="h2">
                Validation de l'échantillon des SIAE
            </p>

            {% if has_active_campaign and evaluation_campaign.percent_set_at%}
                <p>
                    <div class="alert alert-success" role="status">
                        <p>Votre contrôle a posteriori sur la période du {{evaluation_campaign.evaluated_period_start_at|date:"d F Y"}}
                            au {{evaluation_campaign.evaluated_period_end_at|date:"d F Y"}} concerne {{evaluation_campaign.chosen_percent}}%
                            des SIAE.
                            Vous serez notifié lorsque l'étape de transmission des pièces justificatives commencera.
                        </p>
                    </div>
                </p>
            {% elif has_active_campaign %}
                <p>
                    Pour initier le contrôle a posteriori des auto-prescriptions, nous avons besoin de connaître le pourcentage
                    de SIAE que vous souhaitez contrôler. Vous ne pourrez choisir qu'une fois, ensuite, nous effectuerons une sélection
                    aléatoire de SIAE. Veuillez choisir le pourcentage de SIAE à contrôler puis valider ci-dessous :
                </p>
                <form method="post" action="" class="js-prevent-multiple-submit">

                    {% csrf_token %}

                    {% bootstrap_form_errors form alert_error_type="all" %}

                    <p class="font-weight-bold">Ratio sélectionné : <span id="showChosenPercentValue"></span> %</p>
                    <p>{{min}}% {{ form.chosen_percent }} {{max}}%</p>

                    {% buttons %}
                        <button type="submit" class="btn btn-primary  float-right" onclick="return confirm('Le ratio sélectionné ne sera plus modifiable pour cette campagne de contrôle. Confirmez-vous son enregistrement ? ')">
                            Valider
                        </button>
                    {% endbuttons %}

                </form>



            {% else %}
                <p>
                    <div class="alert alert-info" role="status">
                        <p class="font-weight-bold">Vous n'avez pas de contrôle en cours.</p>
                    </div>
                </p>


            {% endif %}


        </div>
    </div>

    {% if back_url %}
        <p class="mt-4">
            <a href="{{ back_url }}">Retour</a>
        </p>
    {% endif %}
{% endblock %}

{% block script %}
    <script type="text/javascript">
        var slider = document.getElementById("chosenPercentRange");
        var output = document.getElementById("showChosenPercentValue");
        output.innerHTML = slider.value;

        slider.oninput = function () {
            output.innerHTML = this.value;
        }

    </script>
{% endblock %}
