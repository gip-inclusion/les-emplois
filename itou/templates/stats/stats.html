{% extends "layout/content.html" %}
{% load static %}

{% block title %}Statistiques et pilotage {{ block.super }}{% endblock %}

{% block content %}
    <h1 class="h1-hero-c1">{{ page_title }}</h1>

    {% if show_siae_evaluation_message %}
        <p>
            Le tableau ci-dessous comprend 100% des auto-prescriptions faites sur la p√©riode de cette campagne, vous y avez acc√®s pour prendre connaissance de ces caract√©ristiques.
        </p>
    {% endif %}

    {% if is_stats_public %}
        <div class="mb-4">
            <i class="ri-external-link-line ri-lg mr-1"></i>.
            Cette page a pour objectif de pr√©senter l'impact des emplois de l'inclusion. Pour retrouver les indicateurs qui √©taient pr√©sent√©s ici, merci de vous rendre sur le
            <a href="{{ ITOU_PILOTAGE_URL }}/tableaux-de-bord" rel="noopener" target="_blank" aria-label="Vous rendre sur le pilotage de l'inclusion (ouverture dans un nouvel onglet)">
                pilotage de l'inclusion
            </a>
        </div>
    {% endif %}

    <script src="{{ stats_base_url }}/app/iframeResizer.js"></script>
    <iframe id="stats-iframe" src="{{ iframeurl }}" frameborder="0">
    </iframe>

    {% if back_url %}
        <p class="mt-4">
            <a href="{{ back_url }}">Retour</a>
        </p>
    {% endif %}


{% endblock %}

{% block post_content %}
    <section class="s-section mt-0 pt-0">
        <div class="s-section__container container">
            <div class="s-section__row row row-cols-1 row-cols-md-2 row-cols-lg-3">
                <div class="col mb-3 mb-md-5">
                    <div class="card c-card c-card--communaute c-card--hovershadow h-100 w-100">
                        <div class="card-header">
                            <h2 class="h2 m-0">Guide d‚Äôutilisation</h2>
                        </div>
                        <div class="card-body">
                            <p>Aide √† la lecture et √† l'utilisation des tableaux de bord</p>
                        </div>
                        <div class="card-footer text-right">
                            <a href="https://communaute.inclusion.beta.gouv.fr/doc/pilotage/guide-d-utilisation/" target="_blank" class="btn btn-sm btn-ico btn-link stretched-link">
                                <span>Acc√©der au guide d‚Äôutilisation</span>
                                <i class="ri-external-link-line ri-lg"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col mb-3 mb-md-5">
                    <div class="card c-card c-card--communaute c-card--hovershadow h-100 w-100">
                        <div class="card-header">
                            <h2 class="h2 m-0">Dictionnaire des indicateurs</h2>
                        </div>
                        <div class="card-body">
                            <p>Liste de tous les indicateurs pr√©sentant leurs d√©finitions, formules et sources de donn√©es</p>
                        </div>
                        <div class="card-footer text-right">
                            <a href="https://communaute.inclusion.beta.gouv.fr/doc/pilotage/dictionnaire-des-indicateurs/" target="_blank" class="btn btn-sm btn-ico btn-link stretched-link">
                                <span>Acc√©der au dictionnaire</span>
                                <i class="ri-external-link-line ri-lg"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col mb-3 mb-md-5">
                    <div class="card c-card c-card--communaute c-card--hovershadow h-100 w-100">
                        <div class="card-header">
                            <h2 class="h2 m-0">Glossaire</h2>
                        </div>
                        <div class="card-body">
                            <p>Comprenez les sigles utilis√©s dans nos tableaux</p>
                        </div>
                        <div class="card-footer text-right">
                            <a href="https://communaute.inclusion.beta.gouv.fr/doc/communaute/glossaire-de-linclusion/" target="_blank" class="btn btn-sm btn-ico btn-link stretched-link">
                                <span>Acc√©der au glossaire</span>
                                <i class="ri-external-link-line ri-lg"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="s-section__row row row-cols-1 row-cols-md-2 row-cols-lg-3">
                <div class="col mb-3 mb-md-5">
                    <div class="card c-card c-card--communaute c-card--hovershadow h-100 w-100">
                        <div class="card-header">
                            <h2 class="h2 m-0">Suggestions</h2>
                        </div>
                        <div class="card-body">
                            <p>Nos tableaux de bord sont amen√©s √† √©voluer pour vous aider au mieux, n‚Äôh√©sitez pas √† nous faire vos retours</p>
                        </div>
                        <div class="card-footer text-right">
                            <a href="https://communaute.inclusion.beta.gouv.fr/suggestions-le-pilotage-de-linclusion/" target="_blank" class="btn btn-sm btn-ico btn-link stretched-link">
                                <span>Acc√©der aux suggestions</span>
                                <i class="ri-external-link-line ri-lg"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col mb-3 mb-md-5">
                    <div class="card c-card c-card--communaute c-card--hovershadow h-100 w-100">
                        <div class="card-header">
                            <h2 class="h2 m-0">Aide et support</h2>
                        </div>
                        <div class="card-body">
                            <p>Si notre documentation ne vous renseigne pas suffisamment, vous pouvez contacter notre support</p>
                        </div>
                        <div class="card-footer text-right">
                            <a href="{{ ITOU_ASSISTANCE_URL }}" target="_blank" class="btn btn-sm btn-ico btn-link stretched-link">
                                <span>Acc√©der au support</span>
                                <i class="ri-external-link-line ri-lg"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

{% endblock %}

{% block script %}
    {{ block.super }}

    <script nonce="{{ CSP_NONCE }}">
        document.getElementById("stats-iframe").addEventListener("load", function(){
            iFrameResize({}, this)
        });
    </script>

    {% if tally_form_id %}
        {# Do not use `async` here otherwise the Tally popup will randomly fail to load. #}
        <script src="https://tally.so/widgets/embed.js"></script>

        {# `defer` ensures the script runs *after* embed.js above has been loaded. #}
        <script defer nonce="{{ CSP_NONCE }}">

            // Any given Tally popup will not be shown more than once every `minDaysBetweenDisplays` days.
            const minDaysBetweenDisplays = 14;
            const delayBeforeShowingPopupInSeconds = 45;
            const formId = '{{ tally_form_id }}';
            const key = 'statsTallyPopupLastShown-' + formId;
            const todaysDate = new Date();

            function supportsLocalStorage() {
                try {
                    return 'localStorage' in window && window['localStorage'] !== null;
                } catch(e){
                    return false;
                }
            };

            function stopShowingPopupForAWhile() {
                localStorage.setItem(key, JSON.stringify(todaysDate));
            }

            function displayTallyPopup() {
                window.Tally.openPopup(formId, {
                    emoji: {
                        text: "üëã",
                        animation: "wave"
                    },
                    onClose: () => {
                        stopShowingPopupForAWhile();
                    },
                    onSubmit: () => {
                        stopShowingPopupForAWhile();
                    }
                });
            };

            function shouldDisplayTallyPopup() {
                if (!supportsLocalStorage()) {
                    return true;
                }
                infoKey = localStorage.getItem(key);
                if (infoKey) {
                    const lastShown = Date.parse(JSON.parse(localStorage.getItem(key)));
                    const milliSecondsElapsed = todaysDate - lastShown;
                    const daysElapsed = milliSecondsElapsed / (1000 * 3600 * 24);
                    if (daysElapsed <= minDaysBetweenDisplays) {
                        return false;
                    };
                };
                return true;
            };

            if (shouldDisplayTallyPopup()) {
                setTimeout(displayTallyPopup, delayBeforeShowingPopupInSeconds * 1000);
            };
        </script>
    {% endif %}
 
{% endblock %}
