{% extends "layout/content.html" %}
{% load static tally %}
{% block title %}Tableau de bord{{ block.super }}{% endblock %}

{% block messages %}
    {{ block.super }}

    {% if current_siae and not current_siae.jobs.exists %}
        <div class="alert alert-warning">
            <p class="mb-0">
                Pour optimiser la réception de vos candidatures, pensez à renseigner le descriptif de vos postes et leurs prérequis.
            </p>
        </div>
    {% endif %}

    {# Alerte pour les employeurs en cas d'absence ou de mauvais score de geocoding. #}
    {% if current_siae and not current_siae.has_reliable_coords %}
        <div class="alert alert-warning mb-0" role="status">
            <p class="mb-0">
                Nous n'avons pas pu géolocaliser votre établissement.
                <br>
                Cela peut affecter sa position dans les résultats de recherche.
                <br>
                {% if user_is_siae_admin %}
                    <a href="{% url 'siaes_views:edit_siae_step_contact_infos' %}">Indiquez une autre adresse</a>
                {% else %}
                    {% with current_siae.active_admin_members.first as admin %}
                        Veuillez contacter un de vos administrateurs (par exemple {{ admin.first_name|title }} {{ admin.last_name|title }}) pour qu'il ou elle indique une autre adresse
                    {% endwith %}
                {% endif %}
                ou <a href="{{ ITOU_ASSISTANCE_URL }}" target="_blank" rel="noopener" title="Contactez-nous en cas de problème (ouverture dans un nouvel onglet)">contactez-nous</a> en cas de problème.
            </p>
        </div>
    {% endif %}

    {# Alerte pour les prescripteurs en cas d'absence ou de mauvais score de geocoding. #}
    {# Seuls les prescripteurs habilités apparaissent dans le moteur de recherche. #}
    {% if current_prescriber_organization and current_prescriber_organization.is_authorized and not current_prescriber_organization.has_reliable_coords %}
        <div class="alert alert-warning mb-0" role="status">
            <p class="mb-0">
                Nous n'avons pas pu géolocaliser votre établissement.
                <br>
                Cela peut affecter sa position dans les résultats de recherche.
                <br>
                {% if user_is_prescriber_org_admin %}
                    <a href="{% url 'prescribers_views:edit_organization' %}">Indiquez une autre adresse</a>
                {% else %}
                    {% with current_prescriber_organization.active_admin_members.first as admin %}
                        Veuillez contacter un de vos administrateurs (par exemple {{ admin.first_name|title }} {{ admin.last_name|title }}) pour qu'il ou elle indique une autre adresse
                    {% endwith %}
                {% endif %}
                ou <a href="{{ ITOU_ASSISTANCE_URL }}" target="_blank" rel="noopener" title="Contactez-nous en cas de problème (ouverture dans un nouvel onglet)">contactez-nous</a> en cas de problème.
            </p>
        </div>
    {% endif %}

    {% if current_siae and not current_siae.is_active %}
        <div class="alert alert-warning mb-0" role="status">
            <p class="mb-0">
                Votre structure
                {% if current_siae.siret %}(inscrite avec le numéro SIRET : {{ current_siae.siret }}){% endif %}
                n'est plus conventionnée.
                <br>
                Par conséquent, elle n'apparaît plus dans les résultats de recherche et plus aucun collaborateur ne peut la rejoindre.
                <br>
                À compter du {{ current_siae.grace_period_end_date|date:"d F Y" }}, l'accès à ce tableau de bord ne sera plus possible.
                <br>

                {% if user_is_siae_admin %}
                    Veuillez dès que possible régulariser votre situation
                    <a href="{% url 'siaes_views:show_financial_annexes' %}">en sélectionnant une annexe financière valide}</a>.
                    <br>
                {% else %}
                    {% with current_siae.active_admin_members.first as admin %}
                        Veuillez contacter un de vos administrateurs (par exemple {{ admin.first_name|title }} {{ admin.last_name|title }}) pour qu'il ou elle régularise la situation de votre structure.
                    {% endwith %}
                {% endif %}
            </p>
        </div>
    {% endif %}

    {% if current_prescriber_organization and current_prescriber_organization.has_pending_authorization %}
        <div class="alert alert-warning" role="status">
            <p class="mb-0">
                Votre habilitation à valider l'éligibilité d'une personne candidate au dispositif d'Insertion par l'Activité Économique est en cours de vérification par nos équipes. Vous ne pouvez pas encore réaliser le diagnostic d'éligibilité des candidats.
            </p>
            {% if current_prescriber_organization.has_pending_authorization_proof %}
                <p class="mb-0">
                    Merci de nous transmettre l'arrêté préfectoral portant mention de cette habilitation :
                    <a href="{% tally_form_url "wgDzz1" idprescriber=current_prescriber_organization.pk iduser=user.pk source=ITOU_ENVIRONMENT %}"
                       rel="noopener"
                       target="_blank"
                       title="Cliquez ici pour l'envoyer (ouverture dans un nouvel onglet)">
                        cliquez ici pour l'envoyer
                        <i class="ri-external-link-line ri-lg"></i>
                    </a>
                </p>
            {% endif %}
        </div>
    {% endif %}

    {# welcoming_tour desactivé spécifiquement pour les institutions partenaires #}
    {# en attendant une carte plus globale sur le sujet #}
    {% if user.joined_recently and not user.is_labor_inspector %}
        {% include "welcoming_tour/includes/message.html" %}
    {% endif %}
{% endblock %}

{% block pre_content %}
    {# Mise en avant temporaire de Dora. #}
    {% if user.is_prescriber or user.is_siae_staff %}
        <section class="s-banner-01 pt-3 pb-0">
            <div class="s-banner-01__container container">
                <div class="s-banner-01__row row">
                    <div class="s-banner-01__col col-12">
                        <div class="d-flex flex-column flex-md-row">
                            <div class="text-center text-md-left mt-3">
                                <a href="https://dora.fabrique.social.gouv.fr/contribuer?utm_source=lesemplois&utm_medium=banniere&utm_campaign=dashboard" target="_blank">
                                    <img src="{% static 'img/logo_dora.svg' %}" alt="DORA : recensement et mise à jour de l’offre d’insertion" width="140">
                                </a>
                            </div>
                            <div class="w-100 mt-3 pl-0 pl-md-3">
                                <p class="h3 mb-2">
                                    Participez au référencement de l’offre d’insertion de votre territoire en renseignant les services que vous utilisez au quotidien.
                                </p>
                                <p class="mb-0 text-right">
                                    <a href="https://dora.fabrique.social.gouv.fr/contribuer?utm_source=lesemplois&utm_medium=banniere&utm_campaign=dashboard" rel="noopener" target="_blank" class="btn btn-sm btn-outline-primary btn-ico">
                                        <span>Je contribue</span>
                                        <i class="ri-arrow-right-line ri-lg"></i>
                                    </a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    {% endif %}
{% endblock %}

{% block content %}

    <h1 class="h1">
        Tableau de bord
        {% if user.is_job_seeker and user.get_full_name %}- <span class="text-muted">{{ user.get_full_name }}</span>{% endif %}
        {% if current_siae %}- <span class="text-muted">{{ current_siae.display_name }}</span>{% endif %}
        {% if current_prescriber_organization %}
            -
            <span class="text-muted">{{ current_prescriber_organization.display_name }}</span>
            {% if current_prescriber_organization.is_authorized %}<i class="ri-award-line ri-2x"></i>{% endif %}
        {% endif %}
        {% if current_institution %}- <span class="text-muted">{{ current_institution.display_name }}</span>{% endif %}
    </h1>

    {% if current_prescriber_organization and current_prescriber_organization.is_authorized %}
        <p class="text-muted">
            <span class="badge badge-pill badge-sm badge-warning">Prescripteur habilité</span>
            {% if current_prescriber_organization.code_safir_pole_emploi %}
                <span class="badge badge-pill badge-sm badge-light">Code SAFIR {{ current_prescriber_organization.code_safir_pole_emploi }}</span>
            {% endif %}
        </p>
    {% endif %}

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 mt-3">

        {% if user.is_staff %}
            {% include "dashboard/includes/admin_card.html" %}
        {% endif %}

        {% if user.is_job_seeker %}
            {% include "dashboard/includes/job_seeker_job_applications_card.html" %}
            {% if user.latest_common_approval %}
                {% include "dashboard/includes/job_seeker_approval_card.html" %}
            {% endif %}
        {% endif %}
        {# end of if user.is_job_seeker #}

        {% if user.is_prescriber %}

            {% if current_prescriber_organization %}
                {% include "dashboard/includes/prescriber_organisation_card.html" %}
            {% endif %}

            {% include "dashboard/includes/prescriber_job_applications_card.html" %}

        {% endif %}
        {# end of if user.is_prescriber #}

        {% if user.is_siae_staff %}
            {% include "dashboard/includes/siae_card.html" %}
            {% include "dashboard/includes/siae_job_applications_card.html" %}
            {% if current_siae.is_subject_to_eligibility_rules %}
                {% include "dashboard/includes/siae_employees_card.html" %}
            {% endif %}

            {% if active_campaigns or evaluated_siae_notifications %}
                {% include "dashboard/includes/siae_evaluation_campains_card.html" %}
            {% endif %}

        {% endif %}
        {# end of if user.is_siae_staff #}

        {% if user.is_labor_inspector %}
            {% include "dashboard/includes/labor_inspector_organization_card.html" %}
        {% endif %}
        {# end of if user.is_labor_inspector #}


        {% if can_view_stats_dashboard_widget %}
            {% include "dashboard/includes/stats.html" %}
        {% endif %}

        {% if can_view_stats_ddets and active_campaigns %}
            {% include "dashboard/includes/labor_inspector_evaluation_campains_card.html" %}
        {% endif %}
    </div>

{% endblock %}
