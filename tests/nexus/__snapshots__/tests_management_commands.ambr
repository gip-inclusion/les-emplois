# serializer version: 1
# name: test_populate_metabase_nexus[SQL queries]
  dict({
    'num_queries': 6,
    'queries': list([
      dict({
        'origin': list([
          '_set_context_connection_wrapper[utils/triggers/__init__.py]',
          'populate_table[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.populate_users[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.handle[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.execute[utils/command.py]',
          'Command.execute[itoutils/django/commands.py]',
          'Command.execute[itoutils/django/commands.py]',
        ]),
        'sql': "SELECT set_config('itou.context', %s, TRUE)",
      }),
      dict({
        'origin': list([
          'populate_table[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.populate_users[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.handle[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.execute[utils/command.py]',
          'Command.execute[itoutils/django/commands.py]',
          'Command.execute[itoutils/django/commands.py]',
        ]),
        'sql': '''
          SELECT "users_user"."id",
                 "users_user"."password",
                 "users_user"."last_login",
                 "users_user"."is_superuser",
                 "users_user"."username",
                 "users_user"."first_name",
                 "users_user"."last_name",
                 "users_user"."is_staff",
                 "users_user"."is_active",
                 "users_user"."date_joined",
                 "users_user"."address_line_1",
                 "users_user"."address_line_2",
                 "users_user"."post_code",
                 "users_user"."city",
                 "users_user"."department",
                 "users_user"."coords",
                 "users_user"."geocoding_score",
                 "users_user"."geocoding_updated_at",
                 "users_user"."ban_api_resolved_address",
                 "users_user"."insee_city_id",
                 "users_user"."title",
                 "users_user"."full_name_search_vector",
                 "users_user"."email",
                 "users_user"."phone",
                 "users_user"."kind",
                 "users_user"."identity_provider",
                 "users_user"."has_completed_welcoming_tour",
                 "users_user"."created_by_id",
                 "users_user"."external_data_source_history",
                 "users_user"."last_checked_at",
                 "users_user"."terms_accepted_at",
                 "users_user"."public_id",
                 "users_user"."address_filled_at",
                 "users_user"."first_login",
                 "users_user"."upcoming_deletion_notified_at",
                 "users_user"."allow_next_sso_sub_update",
                 EXISTS
            (SELECT %s AS "a"
             FROM "prescribers_prescribermembership" U0
             INNER JOIN "users_user" U1 ON (U0."user_id" = U1."id")
             INNER JOIN "prescribers_prescriberorganization" U2 ON (U0."organization_id" = U2."id")
             WHERE (U1."is_active"
                    AND U0."is_active"
                    AND U2."authorization_status" = %s
                    AND U0."user_id" = ("users_user"."id"))
             LIMIT 1) AS "has_authorized_prescriber_orgnization_membership"
          FROM "users_user"
          WHERE ("users_user"."email"::text IS NOT NULL
                 AND "users_user"."is_active"
                 AND "users_user"."kind" IN (%s,
                                             %s))
          ORDER BY RANDOM() ASC
        ''',
      }),
      dict({
        'origin': list([
          'populate_table[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.populate_memberships[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.handle[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.execute[utils/command.py]',
          'Command.execute[itoutils/django/commands.py]',
          'Command.execute[itoutils/django/commands.py]',
        ]),
        'sql': '''
          SELECT "companies_companymembership"."id",
                 "companies_companymembership"."user_id",
                 "companies_companymembership"."is_admin",
                 "companies_companymembership"."company_id",
                 "companies_company"."id",
                 "companies_company"."uid"
          FROM "companies_companymembership"
          INNER JOIN "users_user" ON ("companies_companymembership"."user_id" = "users_user"."id")
          INNER JOIN "companies_company" ON ("companies_companymembership"."company_id" = "companies_company"."id")
          WHERE ("users_user"."is_active"
                 AND "companies_companymembership"."is_active")
          ORDER BY RANDOM() ASC
        ''',
      }),
      dict({
        'origin': list([
          'populate_table[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.populate_memberships[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.handle[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.execute[utils/command.py]',
          'Command.execute[itoutils/django/commands.py]',
          'Command.execute[itoutils/django/commands.py]',
        ]),
        'sql': '''
          SELECT "prescribers_prescribermembership"."id",
                 "prescribers_prescribermembership"."user_id",
                 "prescribers_prescribermembership"."is_admin",
                 "prescribers_prescribermembership"."organization_id",
                 "prescribers_prescriberorganization"."id",
                 "prescribers_prescriberorganization"."uid"
          FROM "prescribers_prescribermembership"
          INNER JOIN "users_user" ON ("prescribers_prescribermembership"."user_id" = "users_user"."id")
          INNER JOIN "prescribers_prescriberorganization" ON ("prescribers_prescribermembership"."organization_id" = "prescribers_prescriberorganization"."id")
          WHERE ("users_user"."is_active"
                 AND "prescribers_prescribermembership"."is_active")
          ORDER BY RANDOM() ASC
        ''',
      }),
      dict({
        'origin': list([
          'populate_table[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.populate_structures[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.handle[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.execute[utils/command.py]',
          'Command.execute[itoutils/django/commands.py]',
          'Command.execute[itoutils/django/commands.py]',
        ]),
        'sql': '''
          SELECT "prescribers_prescriberorganization"."id",
                 "prescribers_prescriberorganization"."address_line_1",
                 "prescribers_prescriberorganization"."address_line_2",
                 "prescribers_prescriberorganization"."post_code",
                 "prescribers_prescriberorganization"."city",
                 "prescribers_prescriberorganization"."department",
                 "prescribers_prescriberorganization"."coords",
                 "prescribers_prescriberorganization"."geocoding_score",
                 "prescribers_prescriberorganization"."geocoding_updated_at",
                 "prescribers_prescriberorganization"."ban_api_resolved_address",
                 "prescribers_prescriberorganization"."insee_city_id",
                 "prescribers_prescriberorganization"."name",
                 "prescribers_prescriberorganization"."created_at",
                 "prescribers_prescriberorganization"."updated_at",
                 "prescribers_prescriberorganization"."uid",
                 "prescribers_prescriberorganization"."active_members_email_reminder_last_sent_at",
                 "prescribers_prescriberorganization"."automatic_geocoding_update",
                 "prescribers_prescriberorganization"."siret",
                 "prescribers_prescriberorganization"."kind",
                 "prescribers_prescriberorganization"."is_brsa",
                 "prescribers_prescriberorganization"."phone",
                 "prescribers_prescriberorganization"."email",
                 "prescribers_prescriberorganization"."website",
                 "prescribers_prescriberorganization"."description",
                 "prescribers_prescriberorganization"."code_safir_pole_emploi",
                 "prescribers_prescriberorganization"."created_by_id",
                 "prescribers_prescriberorganization"."authorization_status",
                 "prescribers_prescriberorganization"."authorization_updated_at",
                 "prescribers_prescriberorganization"."authorization_updated_by_id",
                 "prescribers_prescriberorganization"."is_gps_authorized",
                 "cities_city"."id",
                 "cities_city"."name",
                 "cities_city"."normalized_name",
                 "cities_city"."slug",
                 "cities_city"."department",
                 "cities_city"."post_codes",
                 "cities_city"."code_insee",
                 "cities_city"."coords",
                 "cities_city"."edition_mode",
                 "cities_city"."last_synced_at"
          FROM "prescribers_prescriberorganization"
          LEFT OUTER JOIN "cities_city" ON ("prescribers_prescriberorganization"."insee_city_id" = "cities_city"."id")
          ORDER BY RANDOM() ASC
        ''',
      }),
      dict({
        'origin': list([
          'populate_table[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.populate_structures[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.handle[nexus/management/commands/populate_metabase_nexus.py]',
          'Command.execute[utils/command.py]',
          'Command.execute[itoutils/django/commands.py]',
          'Command.execute[itoutils/django/commands.py]',
        ]),
        'sql': '''
          SELECT "companies_company"."id",
                 "companies_company"."address_line_1",
                 "companies_company"."address_line_2",
                 "companies_company"."post_code",
                 "companies_company"."city",
                 "companies_company"."department",
                 "companies_company"."coords",
                 "companies_company"."geocoding_score",
                 "companies_company"."geocoding_updated_at",
                 "companies_company"."ban_api_resolved_address",
                 "companies_company"."insee_city_id",
                 "companies_company"."name",
                 "companies_company"."created_at",
                 "companies_company"."updated_at",
                 "companies_company"."uid",
                 "companies_company"."active_members_email_reminder_last_sent_at",
                 "companies_company"."automatic_geocoding_update",
                 "companies_company"."siret",
                 "companies_company"."naf",
                 "companies_company"."kind",
                 "companies_company"."brand",
                 "companies_company"."phone",
                 "companies_company"."email",
                 "companies_company"."auth_email",
                 "companies_company"."website",
                 "companies_company"."description",
                 "companies_company"."provided_support",
                 "companies_company"."source",
                 "companies_company"."created_by_id",
                 "companies_company"."block_job_applications",
                 "companies_company"."job_applications_blocked_at",
                 "companies_company"."spontaneous_applications_open_since",
                 "companies_company"."convention_id",
                 "companies_company"."job_app_score",
                 "companies_company"."is_searchable",
                 "companies_company"."rdv_solidarites_id",
                 "cities_city"."id",
                 "cities_city"."name",
                 "cities_city"."normalized_name",
                 "cities_city"."slug",
                 "cities_city"."department",
                 "cities_city"."post_codes",
                 "cities_city"."code_insee",
                 "cities_city"."coords",
                 "cities_city"."edition_mode",
                 "cities_city"."last_synced_at"
          FROM "companies_company"
          LEFT OUTER JOIN "cities_city" ON ("companies_company"."insee_city_id" = "cities_city"."id")
          WHERE NOT ("companies_company"."siret" = %s)
          ORDER BY RANDOM() ASC
        ''',
      }),
    ]),
  })
# ---
