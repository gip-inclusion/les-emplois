name: ðŸ”ª Review app removal

# Run this pipeline when a pull request having the label "review-app" is closed.
on:
  pull_request:
    types: [ unlabeled, closed ]

env:
  CLEVER_TOOLS_DOWNLOAD_URL: https://clever-tools.clever-cloud.com/releases/latest/clever-tools-latest_linux.tar.gz
  CLEVER_TAR_FILE: clever-tools-latest_linux.tar.gz
  CLEVER_CLI: clever-tools-latest_linux/clever
  CLEVER_TOKEN: ${{ secrets.CLEVER_TOKEN }}
  CLEVER_SECRET: ${{ secrets.CLEVER_SECRET }}
  CLEVER_ORG_ID: orga_647d7c8e-c014-4346-b1cb-b97dc8fc6d25
  BRANCH: ${{ github.head_ref }}


jobs:
  delete:
    runs-on: ubuntu-latest
    if: github.event.label.name == '1-recette-jetable' || contains( github.event.pull_request.labels.*.name, '1-recette-jetable')
    permissions: {}

    steps:
    - name: ðŸ“¥ Checkout to the PR branch
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

    - name: ðŸ· Set review app name
      run:
        echo "REVIEW_APP_NAME=`echo \"c1-review-$BRANCH\" | sed -r 's/[^[:alnum:]-]+/-/g' | head -c 63`" >> $GITHUB_ENV

    - name: ðŸ· Set database addon name
      run:
        echo "REVIEW_APP_DB_NAME=`echo $REVIEW_APP_NAME | sed -r 's/-/_/g'`" >> $GITHUB_ENV

    - name: ðŸ¤ Find the application on Clever Cloud
      run: |
        curl $CLEVER_TOOLS_DOWNLOAD_URL > $CLEVER_TAR_FILE
        tar -xvf $CLEVER_TAR_FILE
        echo "Clever CLI version: $($CLEVER_CLI version)"
        $CLEVER_CLI login --token $CLEVER_TOKEN --secret $CLEVER_SECRET
        $CLEVER_CLI link $REVIEW_APP_NAME --org $CLEVER_ORG_ID

    - name: ðŸ’‚ Install Python
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
      with:
        python-version: "3.13"

    - name: ðŸ—‘ Delete S3 bucket
      run: |
        pip install boto3
        scripts/delete-bucket

    - name: ðŸ—‘ Delete the review app
      run: |
        $CLEVER_CLI delete --yes

    - name: ðŸ—‘ Delete the review app database
      run: |
        $CLEVER_CLI addon delete $REVIEW_APP_DB_NAME --org $CLEVER_ORG_ID --yes
