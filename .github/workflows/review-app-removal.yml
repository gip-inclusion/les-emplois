name: ðŸ”ª Review app removal

# Run this pipeline when a pull request having the label "review-app" is closed.
on:
  pull_request:
    types: [ unlabeled, closed ]

env:
  CLEVER_TOOLS_DOWNLOAD_URL: https://clever-tools.clever-cloud.com/releases/latest/clever-tools-latest_linux.tar.gz
  CLEVER_TAR_FILE: clever-tools-latest_linux.tar.gz
  CLEVER_CLI: clever-tools-latest_linux/clever
  CLEVER_TOKEN: ${{ secrets.CLEVER_TOKEN }}
  CLEVER_SECRET: ${{ secrets.CLEVER_SECRET }}
  BRANCH: ${{ github.head_ref }}


jobs:
  delete:
    runs-on: ubuntu-latest
    if: github.event.label.name == '1-recette-jetable' || contains( github.event.pull_request.labels.*.name, '1-recette-jetable')

    steps:
    - name: ðŸ“¥ Checkout to the PR branch
      uses: actions/checkout@v4.1.4

    - name: ðŸ· Set review app name
      run:
        echo "REVIEW_APP_NAME=`echo \"c1-review-$BRANCH\" | sed -r 's/[-;\\/._]+/-/g'`" >> $GITHUB_ENV

    - name: ðŸ· Set database addon name
      run:
        echo "REVIEW_APP_DB_NAME=`echo $REVIEW_APP_NAME | sed -r 's/-/_/g'`" >> $GITHUB_ENV

    - name: ðŸ¤ Find the application on Clever Cloud
      run: |
        curl $CLEVER_TOOLS_DOWNLOAD_URL > $CLEVER_TAR_FILE
        tar -xvf $CLEVER_TAR_FILE
        $CLEVER_CLI login --token $CLEVER_TOKEN --secret $CLEVER_SECRET
        $CLEVER_CLI link $REVIEW_APP_NAME --org itou_review_apps

    - name: ðŸ’‚ Install Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: ðŸ—‘ Delete S3 bucket
      run: |
        pip install boto3
        scripts/delete-bucket

    - name: ðŸ—‘ Delete the review app
      run: |
        $CLEVER_CLI delete --yes

    - name: ðŸ—‘ Delete the review app database
      run: |
        $CLEVER_CLI addon delete $REVIEW_APP_DB_NAME --org itou_review_apps --yes
